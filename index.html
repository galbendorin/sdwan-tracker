<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD-WAN Gantt Pro</title>
    <!-- Tailwind CSS (Dev Script) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Date Adapter (Version Pinned for Stability) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F1F5F9; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Alignment Constants */
        :root {
            --row-height: 36px; /* Compact row height */
            --header-height: 40px;
        }

        /* FIXED: Removed display:flex to allow table-layout to control widths */
        .gantt-row { height: var(--row-height); border-bottom: 1px solid #F1F5F9; box-sizing: border-box; }
        .gantt-row.hidden-row { display: none; } /* For collapsing */

        .gantt-header { height: var(--header-height); background: #F8FAFC; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #E2E8F0; }
        
        /* FIXED: Added table-layout: fixed to strictly obey column widths */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        th { 
            white-space: nowrap; font-size: 0.65rem; color: #64748B; 
            text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; text-align: left; padding: 0 4px;
            height: var(--header-height); background: #F8FAFC;
            position: relative; /* For resizer positioning */
        }
        td { 
            white-space: nowrap; font-size: 0.7rem; color: #334155; 
            padding: 0 4px; vertical-align: middle; height: var(--row-height);
            overflow: hidden; text-overflow: ellipsis;
        }
        
        /* Column Resizer Styles */
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            touch-action: none;
            z-index: 10;
        }
        .resizer:hover, .resizing {
            background-color: #6366F1; /* Indigo-500 highlight on hover/drag */
        }

        /* Editable Cells */
        .editable { cursor: pointer; transition: background-color 0.15s; }
        .editable:hover { background-color: #F1F5F9; color: #4F46E5; }
        .editing { padding: 0 !important; }
        .editing input, .editing select { width: 100%; height: 100%; border: 2px solid #6366F1; padding: 0 4px; font-size: 0.7rem; outline: none; background: #EEF2FF; }

        .truncate-text { max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        .btn-icon { padding: 2px; border-radius: 4px; color: #94A3B8; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon:hover { color: #6366F1; background-color: #EEF2FF; }

        .btn-icon-green { padding: 2px; border-radius: 4px; color: #10B981; font-weight: bold; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon-green:hover { color: #047857; background-color: #ECFDF5; }

        .btn-icon-danger { padding: 2px; border-radius: 4px; color: #94A3B8; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon-danger:hover { color: #F43F5E; background-color: #FFF1F2; }

        .toggle-btn { cursor: pointer; display: inline-block; width: 12px; text-align: center; color: #64748B; font-weight: bold; user-select: none; font-size: 10px; }
        .toggle-btn:hover { color: #4F46E5; }

        /* Modal Styles */
        .modal-overlay { 
            background-color: rgba(0, 0, 0, 0.2); 
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="flex-none bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center z-30 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">P</div>
            <div>
                <h1 class="text-base font-bold text-slate-900 leading-tight">SD-WAN Project Plan</h1>
                <p class="text-[10px] text-slate-500">Pro Gantt | <span id="task-count">0</span> Items</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Data Controls -->
            <div class="flex items-center gap-2 mr-2">
                <button onclick="loadTemplate()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>
                    Template
                </button>
                <button onclick="downloadCSV()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Export
                </button>
                <button onclick="document.getElementById('fileImport').click()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    Import
                </button>
                <input type="file" id="fileImport" accept=".csv" class="hidden" onchange="importCSV(this)">
            </div>

            <!-- Baseline Controls -->
            <div class="flex items-center gap-2 mr-2 border-l border-r border-slate-200 px-2">
                <!-- NEW: Timeline View Dropdown -->
                <select onchange="setViewMode(this.value)" class="text-[10px] font-bold uppercase text-slate-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors outline-none cursor-pointer">
                    <option value="week" selected>1 Week</option>
                    <option value="2week">2 Weeks</option>
                    <option value="month">1 Month</option>
                </select>

                <button onclick="setBaseline()" class="text-[10px] font-bold uppercase text-slate-500 hover:text-rose-600 bg-slate-50 hover:bg-rose-50 px-2 py-1 rounded transition-colors" title="Overwrite current baseline with active schedule">
                    Re-Base
                </button>
                <label class="flex items-center gap-1 cursor-pointer select-none">
                    <input type="checkbox" id="showBaselineToggle" checked onchange="toggleBaseline()" class="form-checkbox h-3 w-3 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <span class="text-[10px] font-bold uppercase text-slate-500">Base</span>
                </label>
            </div>

            <!-- Add Task Button -->
            <button onclick="openTaskModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add
            </button>

            <!-- Report Button -->
            <button onclick="openReportModal()" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Report
            </button>

            <!-- NEW: AI Assistant Button -->
            <button onclick="openAIModal()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-all border border-indigo-400/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                AI Assistant
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-grow flex overflow-hidden" id="main-container">
        
        <!-- LEFT: Data Table -->
        <!-- MODIFIED: Added ID, removed fixed width classes, added inline style for dynamic resizing -->
        <div id="left-panel" class="flex-none border-r border-slate-200 bg-white flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20" style="width: 35%; min-width: 200px;">
            <div class="flex-grow overflow-auto" id="grid-scroll">
                <table class="w-full">
                    <thead class="gantt-header">
                        <tr>
                            <!-- Column Headers with Resizing Logic via JS -->
                            <th class="w-8 text-center">ID</th>
                            <th>Name</th>
                            <th class="w-10 text-center" title="Dependency">Dep</th>
                            <th class="w-12 text-center" title="Dependency Type">Typ</th>
                            <th class="w-10 text-center">Dur</th>
                            <th class="w-24">Start</th>
                            <th class="w-24">Finish</th>
                            <th class="w-10 text-center">%</th>
                            <th class="w-28 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="grid-body"></tbody>
                </table>
            </div>
        </div>

        <!-- NEW: Resizer Handle -->
        <div id="panel-resizer" class="w-1 bg-slate-200 hover:bg-indigo-500 cursor-col-resize z-30 transition-colors flex-none"></div>

        <!-- RIGHT: Gantt Chart -->
        <div class="flex-grow flex flex-col bg-white relative min-w-0 overflow-hidden">
            <!-- Timeline Header (Frozen) -->
            <div id="chart-header-container" class="flex-none overflow-hidden bg-slate-50 border-b border-slate-200" style="height: 40px;">
                 <div id="axis-wrapper" class="relative"> 
                     <canvas id="axisCanvas"></canvas>
                 </div>
            </div>

            <!-- Scrollable Timeline Body -->
            <div class="flex-grow overflow-auto" id="chart-scroll">
                <div id="chart-container" class="relative">
                    <canvas id="ganttCanvas"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal (Only for Add New) -->
    <div id="taskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 m-4 border border-slate-200">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Add New Task</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="p-6 space-y-4 bg-white/95">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Task Name</label>
                    <input type="text" id="m-name" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <input type="hidden" id="m-indent" value="0">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                        <select id="m-type" onchange="toggleDurationState()" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="Task">Task</option>
                            <option value="Milestone">Milestone</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Duration (Days)</label>
                        <input type="number" id="m-dur" value="1" min="0" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <h4 class="text-xs font-bold text-indigo-800 uppercase mb-2">Dependency Logic</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-1">Predecessor ID</label>
                            <input type="number" id="m-parent" placeholder="e.g. 10" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-1">Dep. Type</label>
                            <select id="m-depType" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                <option value="FS">Finish-to-Start (FS)</option>
                                <option value="SS">Start-to-Start (SS)</option>
                                <option value="FF">Finish-to-Finish (FF)</option>
                                <option value="SF">Start-to-Finish (SF)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                        <input type="date" id="m-start" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">% Complete</label>
                        <input type="number" id="m-pct" value="0" min="0" max="100" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                
                <div id="div-insert" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Insert After</label>
                    <select id="m-insert" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                        <option value="end">-- End of List --</option>
                    </select>
                </div>
                
                <input type="hidden" id="m-finish"> 
            </div>

            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="saveTask()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <!-- ... existing report modal content ... -->
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 m-4 border border-slate-200">
            <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-red-800">Report Issue / Request</h3>
                <button onclick="closeReportModal()" class="text-red-400 hover:text-red-600">&times;</button>
            </div>
            <div class="p-6 space-y-4 bg-white">
                <p class="text-sm text-slate-600 leading-relaxed">
                    Thanks for reporting. Please describe the issue or suggestion below. 
                    Once saved, a CSV file will download.
                </p>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                    <textarea id="report-text" rows="4" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-500 outline-none" placeholder="Describe the bug or feature request..."></textarea>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeReportModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="saveReport()" class="px-4 py-2 text-sm font-bold text-white bg-red-600 rounded hover:bg-red-700 shadow-sm">Save & Download</button>
            </div>
        </div>
    </div>

    <!-- NEW: AI Assistant Modal -->
    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100 m-4 border border-indigo-200 flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center flex-none">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-indigo-100 rounded-md text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">Project AI Assistant</h3>
                        <p class="text-xs text-slate-500">Powered by Gemini 2.0 Flash</p>
                    </div>
                </div>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button onclick="aiAnalyzeRisks()" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all group">
                        <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸ“‰</span>
                        <span class="text-xs font-bold text-slate-700 uppercase">Analyze Risks</span>
                    </button>
                    <button onclick="aiDraftStatus()" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all group">
                        <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸ“§</span>
                        <span class="text-xs font-bold text-slate-700 uppercase">Draft Status Email</span>
                    </button>
                    <div class="relative w-full">
                        <button onclick="aiBreakdownTask()" class="w-full h-full flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all group">
                            <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸ”¨</span>
                            <span class="text-xs font-bold text-slate-700 uppercase">Break Down Task</span>
                        </button>
                        <select id="ai-task-selector" class="absolute bottom-1 left-2 right-2 text-[10px] border border-slate-200 rounded bg-white opacity-0 hover:opacity-100 focus:opacity-100 transition-opacity cursor-pointer">
                            <option value="">-- Select Task to Break Down --</option>
                        </select>
                    </div>
                </div>

                <!-- Result Area -->
                <div class="bg-slate-50 rounded-lg border border-slate-200 min-h-[150px] flex flex-col">
                    <div class="px-4 py-2 border-b border-slate-200 flex justify-between items-center bg-slate-100">
                        <span class="text-xs font-bold text-slate-500 uppercase">AI Response</span>
                        <div id="ai-loading" class="hidden flex items-center gap-2">
                            <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                    <div id="ai-output" class="p-4 text-sm text-slate-700 font-mono whitespace-pre-wrap leading-relaxed overflow-y-auto max-h-[300px]">Select an action above...</div>
                </div>
            </div>

            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-between items-center flex-none">
                <span class="text-[10px] text-slate-400 italic">AI responses may be inaccurate. Review before applying.</span>
                <button onclick="closeAIModal()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATASET ---
        const apiKey = ""; // API Key injected by environment
        let projectData = []; 
        let collapsedParents = new Set(); // To track collapsed rows
        let viewMode = 'week'; // Default view mode

        // --- TEMPLATE DATA ---
        const templateData = [
            { id: 1, name: "Project Plan", type: "root", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 0 },
            { id: 2, name: "Project Milestones", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 3, name: "Pre-sales / Contract and PO signed", type: "Milestone", parent: 9, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 4, name: "Project Gate 1 - Kick off and Pilot Initiation", type: "Milestone", parent: 17, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 5, name: "Project Gate 2 - Onboarding and technical discovery", type: "Milestone", parent: 33, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 6, name: "Project Gate 3 - Pilot", type: "Milestone", parent: 45, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 7, name: "Project Gate 4 - Rollout", type: "Milestone", parent: 59, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 8, name: "Project Gate 5 - Service Handover and Closure", type: "Milestone", parent: 75, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            
            { id: 9, name: "Pre-sales / Contract and PO signed", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 10, name: "Confirm final design with client", type: "Task", parent: 1, depType: "FS", dur: 3, start: "2026-01-09", pct: 100, indent: 2 },
            { id: 11, name: "Prepare SSD incl. cabling & design assumptions", type: "Task", parent: 10, depType: "FS", dur: 2, start: "2026-01-14", pct: 100, indent: 2 },
            { id: 12, name: "Enter orders into GTT system", type: "Task", parent: 10, depType: "FS", dur: 10, start: "2026-01-14", pct: 100, indent: 2 },
            { id: 13, name: "MSA signature", type: "Task", parent: 10, depType: "FS", dur: 12, start: "2026-01-14", pct: 0, indent: 2 },
            { id: 14, name: "PONs to be re-signed", type: "Task", parent: 12, depType: "FS", dur: 5, start: "2026-01-28", pct: 10, indent: 2 },
            { id: 15, name: "Orders validated by OA & SC", type: "Task", parent: 14, depType: "FS", dur: 2, start: "2026-02-04", pct: 10, indent: 2 },
            { id: 16, name: "EnvisionEdge Certification", type: "Task", parent: 1, depType: "FS", dur: 6, start: "2026-01-09", pct: 100, indent: 2 },
            
            { id: 17, name: "Project Gate 1 - Kick off and Pilot Initiation", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 18, name: "Internal Project Acceptance", type: "Task", parent: 15, depType: "FS", dur: 3, start: "2026-02-06", pct: 100, indent: 2 },
            { id: 19, name: "PON Data Validation - PM", type: "Task", parent: 18, depType: "FS", dur: 1, start: "2026-02-11", pct: 100, indent: 2 },
            { id: 20, name: "External Project Kick off", type: "Task", parent: 19, depType: "FS", dur: 2, start: "2026-02-12", pct: 100, indent: 2 },
            { id: 21, name: "Has the Project Initiation Document been agreed", type: "Task", parent: 20, depType: "FS", dur: 2, start: "2026-02-16", pct: 40, indent: 2 },
            { id: 22, name: "Has the Project Plan been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 23, name: "Has the Project Master Tracker been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 24, name: "Has the RAID Log been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 25, name: "Have the External Status Report been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 26, name: "Solution Consultant shared the SSD", type: "Task", parent: 16, depType: "FS", dur: 8, start: "2026-01-19", pct: 50, indent: 2 },
            { id: 27, name: "Solution Consultant shared the TAD", type: "Task", parent: 15, depType: "FS", dur: 2, start: "2026-02-06", pct: 90, indent: 2 },
            { id: 28, name: "Client to provide updated IP addresses", type: "Task", parent: 12, depType: "FS", dur: 1, start: "2026-01-28", pct: 90, indent: 2 },
            
            { id: 29, name: "Scope change", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 30, name: "Adding site 6B in CMD", type: "Task", parent: 29, depType: "FS", dur: 10, start: "2026-01-28", pct: 25, indent: 2 },
            { id: 31, name: "Receive the technical solution", type: "Task", parent: 30, depType: "FS", dur: 10, start: "2026-01-28", pct: 0, indent: 2 },
            { id: 32, name: "Complete pre-staging", type: "Task", parent: 31, depType: "FS", dur: 10, start: "2026-02-11", pct: 0, indent: 2 },
            
            { id: 33, name: "Project Gate 2 - Onboarding", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 34, name: "Scope/TAD been approved by TDA", type: "Task", parent: 27, depType: "FS", dur: 2, start: "2026-02-10", pct: 10, indent: 2 },
            { id: 35, name: "SD WAN Technical Workshop(s) Scheduled", type: "Task", parent: 27, depType: "FS", dur: 2, start: "2026-02-10", pct: 0, indent: 2 },
            { id: 36, name: "Review the configurations", type: "Task", parent: 27, depType: "FS", dur: 20, start: "2026-02-10", pct: 0, indent: 2 },
            { id: 37, name: "Provide feedback/Agree on the solution", type: "Task", parent: 36, depType: "FS", dur: 5, start: "2026-03-10", pct: 0, indent: 2 },
            { id: 38, name: "Has all client info been supplied?", type: "Task", parent: 28, depType: "FS", dur: 15, start: "2026-01-29", pct: 10, indent: 2 },
            
            { id: 39, name: "Logistics", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 40, name: "NetProv & SCM - confirm", type: "Task", parent: 15, depType: "FS", dur: 0, start: "2026-02-06", pct: 100, indent: 2 },
            { id: 41, name: "Pilot pre-staging completed", type: "Task", parent: 28, depType: "FS", dur: 6, start: "2026-01-29", pct: 75, indent: 2 },
            { id: 42, name: "HW for Pilot sites Shipment", type: "Task", parent: 41, depType: "FS", dur: 15, start: "2026-02-06", pct: 0, indent: 2 },
            { id: 43, name: "Remaining 11 sites pre-staging completed", type: "Task", parent: 27, depType: "FS", dur: 10, start: "2026-02-10", pct: 0, indent: 2 },
            { id: 44, name: "HW for 11+1.5 sites Shipment", type: "Task", parent: 43, depType: "FS", dur: 15, start: "2026-02-24", pct: 0, indent: 2 },
            
            { id: 45, name: "Project Gate 3 - Pilot", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 46, name: "Identify Pilot sites", type: "Task", parent: 21, depType: "FS", dur: 1, start: "2026-02-18", pct: 100, indent: 2 },
            { id: 47, name: "SD-WAN Technical Workshop (Final)", type: "Task", parent: 42, depType: "FS", dur: 3, start: "2026-02-27", pct: 0, indent: 2 },
            { id: 48, name: "Final Low Level Diagrams supplied", type: "Task", parent: 47, depType: "FS", dur: 1, start: "2026-03-04", pct: 0, indent: 2 },
            { id: 49, name: "Define Success vs Failure Scope", type: "Task", parent: 34, depType: "FS", dur: 5, start: "2026-02-18", pct: 0, indent: 2 },
            { id: 50, name: "Determine UAT", type: "Task", parent: 47, depType: "FS", dur: 1, start: "2026-03-04", pct: 0, indent: 2 },
            { id: 51, name: "Create a detailed runbook", type: "Task", parent: 47, depType: "FS", dur: 1, start: "2026-03-04", pct: 0, indent: 2 },
            
            { id: 52, name: "Migration onto SD WAN", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 53, name: "Site 1 DC Ecity", type: "Task", parent: 48, depType: "FS", dur: 5, start: "2026-03-05", pct: 0, indent: 2 },
            { id: 54, name: "Site 2 - Hyderabad", type: "Task", parent: 53, depType: "FS", dur: 2, start: "2026-03-12", pct: 0, indent: 2 },
            { id: 55, name: "Site 3 - Hennagara", type: "Task", parent: 54, depType: "FS", dur: 2, start: "2026-03-16", pct: 0, indent: 2 },
            { id: 56, name: "Design Agreed and signed", type: "Task", parent: 55, depType: "FS", dur: 5, start: "2026-03-18", pct: 0, indent: 2 },
            { id: 57, name: "Create the DDD", type: "Task", parent: 56, depType: "FS", dur: 1, start: "2026-03-25", pct: 0, indent: 2 },
            { id: 58, name: "Handover to Net Prov", type: "Task", parent: 57, depType: "FS", dur: 1, start: "2026-03-26", pct: 0, indent: 2 },
            
            { id: 59, name: "Project Gate 4 - Rollout", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 60, name: "Site 3", type: "Task", parent: 58, depType: "FS", dur: 5, start: "2026-03-27", pct: 0, indent: 2 },
            { id: 61, name: "Site 4", type: "Task", parent: 60, depType: "FS", dur: 2, start: "2026-04-03", pct: 0, indent: 2 },
            { id: 62, name: "Site 5", type: "Task", parent: 61, depType: "FS", dur: 2, start: "2026-04-07", pct: 0, indent: 2 },
            { id: 63, name: "Site 6", type: "Task", parent: 62, depType: "FS", dur: 2, start: "2026-04-09", pct: 0, indent: 2 },
            { id: 64, name: "Site 7", type: "Task", parent: 63, depType: "FS", dur: 2, start: "2026-04-13", pct: 0, indent: 2 },
            { id: 65, name: "Site 8", type: "Task", parent: 64, depType: "FS", dur: 2, start: "2026-04-15", pct: 0, indent: 2 },
            { id: 66, name: "Site 9", type: "Task", parent: 65, depType: "FS", dur: 2, start: "2026-04-17", pct: 0, indent: 2 },
            { id: 67, name: "Site 10", type: "Task", parent: 66, depType: "FS", dur: 2, start: "2026-04-21", pct: 0, indent: 2 },
            { id: 68, name: "Site 11", type: "Task", parent: 67, depType: "FS", dur: 2, start: "2026-04-23", pct: 0, indent: 2 },
            { id: 69, name: "Site 12", type: "Task", parent: 68, depType: "FS", dur: 2, start: "2026-04-27", pct: 0, indent: 2 },
            { id: 70, name: "Site 13", type: "Task", parent: 69, depType: "FS", dur: 2, start: "2026-04-29", pct: 0, indent: 2 },
            { id: 71, name: "Site 14", type: "Task", parent: 70, depType: "FS", dur: 2, start: "2026-05-01", pct: 0, indent: 2 },
            { id: 72, name: "Any issues with deployment", type: "Task", parent: 71, depType: "FS", dur: 10, start: "2026-05-05", pct: 0, indent: 2 },
            { id: 73, name: "EnvisionDX access granted", type: "Task", parent: 54, depType: "FS", dur: 1, start: "2026-03-16", pct: 0, indent: 2 },
            { id: 74, name: "Service Management / Account reviews", type: "Task", parent: 54, depType: "FS", dur: 1, start: "2026-03-16", pct: 0, indent: 2 },
            
            { id: 75, name: "Project Gate 5 - Service Handover and Closure", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 76, name: "Lesssons Learned meeting", type: "Task", parent: 72, depType: "FS", dur: 3, start: "2026-05-19", pct: 0, indent: 2 },
            { id: 77, name: "Project Closed", type: "Milestone", parent: 76, depType: "FS", dur: 2, start: "2026-05-22", pct: 0, indent: 2 }
        ];

        // --- 2. LOGIC ---
        const criticalPathSet = new Set();
        let showBaseline = true;

        function initData() {
            projectData.forEach(t => {
                if (!t.baseStart) t.baseStart = t.start;
                if (!t.baseDur) t.baseDur = t.dur;
                if (!t.depType) t.depType = "FS"; 
                if (t.indent === undefined) t.indent = 0;
            });
        }

        // --- RESIZING LOGIC ---
        function enableColumnResizing() {
            const headers = document.querySelectorAll('th');
            // We don't necessarily need to select table here if we rely on computed styles,
            // but ensuring the table isn't display: flex is key (handled in CSS).

            headers.forEach(th => {
                // Create resizer handle
                const resizer = document.createElement('div');
                resizer.classList.add('resizer');
                th.appendChild(resizer);

                // Drag logic variables
                let startX = 0;
                let startWidth = 0;

                const mouseDownHandler = (e) => {
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    
                    // Stop event bubbling so it doesn't trigger sort/other actions
                    e.stopPropagation();

                    // Add listeners to document so dragging works even if mouse leaves the handle
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    resizer.classList.add('resizing');
                };

                const mouseMoveHandler = (e) => {
                    const dx = e.pageX - startX;
                    const newWidth = Math.max(30, startWidth + dx); // Minimum width 30px
                    th.style.width = `${newWidth}px`;
                };

                const mouseUpHandler = () => {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    resizer.classList.remove('resizing');
                };

                resizer.addEventListener('mousedown', mouseDownHandler);
            });
        }

        // NEW: Panel Resizing Logic
        function enablePanelResizing() {
            const resizer = document.getElementById('panel-resizer');
            const leftPanel = document.getElementById('left-panel');
            const mainContainer = document.getElementById('main-container');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                resizer.classList.add('bg-indigo-600'); // Active state visual
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                // Calculate new width percentage based on mouse position relative to container
                const containerWidth = mainContainer.offsetWidth;
                const newWidthPct = (e.clientX / containerWidth) * 100;
                
                // Set limits (e.g., maintain at least 10% and leave at least 10% for chart)
                if(newWidthPct > 10 && newWidthPct < 90) {
                    leftPanel.style.width = `${newWidthPct}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                    resizer.classList.remove('bg-indigo-600');
                }
            });
        }

        function setViewMode(mode) {
            viewMode = mode;
            renderChart();
        }

        function loadTemplate() {
            if(projectData.length > 0 && !confirm("Load Standard SD-WAN Template? This will overwrite current data.")) return;
            
            projectData = JSON.parse(JSON.stringify(templateData));
            calculateSchedule(); 
            projectData.forEach(t => {
                t.baseStart = t.start;
                t.baseDur = t.dur;
            });
            refreshView();
        }
        
        function calculateCriticalPath() {
            criticalPathSet.clear();
            if (projectData.length === 0) return;
            
            let lastTask = projectData[0];
            let maxEnd = 0;
            projectData.forEach(t => {
                const end = new Date(t.start).getTime() + (t.dur * 86400000);
                if (end > maxEnd) { maxEnd = end; lastTask = t; }
            });

            if(!lastTask) return;

            const trace = (taskId) => {
                criticalPathSet.add(taskId);
                const t = projectData.find(x => x.id === taskId);
                if (t && t.parent) trace(t.parent);
            };
            trace(lastTask.id);
        }

        function calculateSchedule() {
            const taskMap = new Map(projectData.map(t => [t.id, t]));
            const cache = new Map();
            const stack = []; 

            function resolveStart(taskId) {
                if(cache.has(taskId)) return cache.get(taskId);
                
                const task = taskMap.get(taskId);
                if(!task) return new Date(); 
                
                if(stack.includes(taskId)) {
                    console.warn("Circular dependency detected:", taskId);
                    return new Date(task.start);
                }
                stack.push(taskId);

                if(!task.parent || !taskMap.has(task.parent)) {
                    const d = new Date(task.start);
                    cache.set(taskId, d);
                    stack.pop();
                    return d;
                }

                const pStart = resolveStart(task.parent);
                const parent = taskMap.get(task.parent);
                
                const pDur = parent.dur || 0;
                const pEnd = new Date(pStart.getTime() + (pDur * 86400000));
                
                let newStart;
                switch(task.depType) {
                    case 'SS': newStart = pStart; break;
                    case 'FF': newStart = new Date(pEnd.getTime() - (task.dur * 86400000)); break;
                    case 'SF': newStart = new Date(pStart.getTime() - (task.dur * 86400000)); break;
                    case 'FS': default: newStart = pEnd; break;
                }
                
                if (isNaN(newStart.getTime())) newStart = pEnd;
                
                cache.set(taskId, newStart);
                stack.pop();
                return newStart;
            }

            projectData.forEach(task => {
                const s = resolveStart(task.id);
                task.start = s.toISOString().split('T')[0];
            });
        }

        function setBaseline() {
            if(confirm("Overwrite Baseline?")) {
                projectData.forEach(t => { t.baseStart = t.start; t.baseDur = t.dur; });
                renderChart();
            }
        }

        function toggleBaseline() {
            showBaseline = document.getElementById('showBaselineToggle').checked;
            renderChart();
        }

        function toggleDurationState() {
            const type = document.getElementById('m-type').value;
            const durInput = document.getElementById('m-dur');
            if (type === 'Milestone') {
                durInput.value = 0;
                durInput.disabled = true;
                durInput.classList.add('bg-slate-100', 'text-slate-400');
            } else {
                durInput.disabled = false;
                durInput.classList.remove('bg-slate-100', 'text-slate-400');
            }
        }

        function modifyIndent(id, change) {
            const task = projectData.find(t => t.id === id);
            if(task) {
                task.indent = Math.max(0, (task.indent || 0) + change);
                renderTable();
            }
        }

        function toggleCollapse(id) {
            if(collapsedParents.has(id)) collapsedParents.delete(id);
            else collapsedParents.add(id);
            renderTable();
            renderChart();
        }

        function isRowVisible(index) {
            if (index === 0) return true;
            let currentIndent = projectData[index].indent;
            for(let i = index - 1; i >= 0; i--) {
                const t = projectData[i];
                if(t.indent < currentIndent) {
                    if(collapsedParents.has(t.id)) return false;
                    currentIndent = t.indent;
                }
                if(currentIndent === 0) break;
            }
            return true;
        }

        // --- IMPORT/EXPORT ---
        function downloadCSV() {
            const headers = ["ID", "Name", "Type", "Parent", "DepType", "Duration", "Start", "Finish", "Percent", "BaseStart", "BaseDur", "Indent"];
            const rows = projectData.map(t => {
                const startDate = new Date(t.start);
                const endDate = new Date(startDate.getTime() + (t.dur * 86400000));
                return [
                    t.id, `"${(t.name || '').replace(/"/g, '""')}"`, t.type, t.parent || '', t.depType || 'FS', 
                    t.dur, t.start, endDate.toISOString().split('T')[0], t.pct, t.baseStart || t.start, t.baseDur || t.dur, t.indent || 0
                ];
            });
            const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "sdwan_project.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                const newProjectData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || lines[i].split(',');
                    const clean = cols.map(c => c.replace(/^"|"$/g, '').replace(/""/g, '"'));
                    if (clean.length >= 9) {
                        newProjectData.push({
                            id: parseInt(clean[0]), name: clean[1], type: clean[2], parent: clean[3] ? parseInt(clean[3]) : null, 
                            depType: clean[4] || 'FS', dur: parseInt(clean[5]), start: clean[6], pct: parseInt(clean[8]),
                            baseStart: clean[9] || clean[6], baseDur: parseInt(clean[10]) || parseInt(clean[5]),
                            indent: parseInt(clean[11]) || 0
                        });
                    }
                }
                if (newProjectData.length > 0) {
                    projectData = newProjectData;
                    calculateSchedule();
                    refreshView();
                    alert("Project loaded!");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- REPORTING ---
        function openReportModal() {
            document.getElementById('report-text').value = "";
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        function saveReport() {
            const text = document.getElementById('report-text').value;
            if(!text.trim()) { alert("Please enter a description."); return; }
            const timestamp = new Date().toISOString();
            const headers = ["Timestamp", "Type", "Description"];
            const row = [timestamp, "User Report/Request", `"${text.replace(/"/g, '""')}"`];
            const csvContent = [headers.join(","), row.join(",")].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const filename = `report_dorin_${new Date().toISOString().slice(0,10)}.csv`;
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            closeReportModal();
            alert("Report downloaded! Please send to Dorin.");
        }

        // --- AI FEATURES ---
        function openAIModal() {
            // Populate task selector
            const select = document.getElementById('ai-task-selector');
            select.innerHTML = '<option value="">-- Select Parent Task --</option>';
            projectData.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.text = `[${t.id}] ${t.name.substring(0,40)}`;
                select.appendChild(opt);
            });
            
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('ai-output').textContent = "Ready to assist. Select an action above.";
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        async function callGemini(prompt) {
            const outputDiv = document.getElementById('ai-output');
            const loader = document.getElementById('ai-loading');
            
            outputDiv.textContent = "";
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                loader.classList.add('hidden');

                if (data.candidates && data.candidates.length > 0) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("No response from AI");
                }
            } catch (error) {
                loader.classList.add('hidden');
                outputDiv.textContent = "Error calling AI: " + error.message;
                return null;
            }
        }

        async function aiAnalyzeRisks() {
            // Create a lightweight summary of the project to save tokens
            const summary = projectData.map(t => ({
                id: t.id, name: t.name, dur: t.dur, 
                pct: t.pct, dep: t.parent
            }));
            
            const prompt = `Act as a Senior Project Manager. Analyze this SD-WAN project schedule (JSON below) for risks. 
            Focus on: 
            1. Unrealistic durations (too short/long).
            2. Bottlenecks (tasks with many dependencies).
            3. Tasks with 0% progress that should have started.
            
            Keep the response concise, bulleted, and professional.
            
            Data: ${JSON.stringify(summary)}`;

            const result = await callGemini(prompt);
            if(result) document.getElementById('ai-output').textContent = result;
        }

        async function aiDraftStatus() {
            const completed = projectData.filter(t => t.pct === 100).length;
            const total = projectData.length;
            const percent = Math.round((completed/total)*100);
            
            const prompt = `Draft a professional email to stakeholders about this SD-WAN project.
            
            Stats: ${percent}% complete. ${completed}/${total} tasks done.
            Project Start: ${projectData[0]?.start || 'N/A'}.
            
            Structure:
            1. Executive Summary
            2. Key Achievements (invent 2-3 generic ones based on SD-WAN context)
            3. Next Steps
            4. Risks/Blockers (mention "None currently reported" if unknown)
            
            Tone: Professional, concise.`;

            const result = await callGemini(prompt);
            if(result) document.getElementById('ai-output').textContent = result;
        }

        async function aiBreakdownTask() {
            const select = document.getElementById('ai-task-selector');
            const parentId = parseInt(select.value);
            
            if(!parentId) {
                document.getElementById('ai-output').textContent = "Please select a task from the dropdown inside the 'Break Down Task' button area first.";
                return;
            }

            const parentTask = projectData.find(t => t.id === parentId);
            if(!parentTask) return;

            const prompt = `I have a task named "${parentTask.name}" in an SD-WAN project.
            Break this down into 3-5 logical subtasks.
            
            IMPORTANT: Return ONLY a valid JSON array. Do not include markdown formatting (like \`\`\`json).
            Format: [{"name": "Subtask Name", "dur": 3}, {"name": "Another Subtask", "dur": 2}]`;

            const result = await callGemini(prompt);
            
            if(result) {
                try {
                    // Clean text just in case AI adds markdown
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const subtasks = JSON.parse(cleanJson);
                    
                    let msg = `Generated ${subtasks.length} subtasks for "${parentTask.name}":\n`;
                    
                    // Add to project data
                    const parentIdx = projectData.findIndex(t => t.id === parentId);
                    const newIndent = (parentTask.indent || 0) + 1;
                    const maxId = Math.max(...projectData.map(t => t.id));
                    let currentId = maxId + 1;
                    
                    // Reverse loop to insert right after parent without messing up order
                    for(let i = subtasks.length - 1; i >= 0; i--) {
                        const st = subtasks[i];
                        const newTask = {
                            id: currentId++,
                            name: "âœ¨ " + st.name, // Mark as AI generated
                            type: 'Task',
                            parent: parentId,
                            depType: 'FS',
                            dur: st.dur || 1,
                            start: parentTask.start, // Logic will fix date later
                            pct: 0,
                            baseStart: parentTask.start,
                            baseDur: st.dur || 1,
                            indent: newIndent
                        };
                        projectData.splice(parentIdx + 1, 0, newTask);
                        msg += `- [Added] ${st.name} (${st.dur} days)\n`;
                    }
                    
                    refreshView();
                    document.getElementById('ai-output').textContent = msg + "\n\nSchedule updated automatically!";
                    
                } catch(e) {
                    document.getElementById('ai-output').textContent = "Failed to parse AI response. Raw output:\n" + result;
                }
            }
        }

        // --- MODAL ---
        let editingId = null;
        let insertTargetId = null;
        let isCreatingSubtask = false;

        function openTaskModal(id = null, mode = 'edit') {
            try {
                const modal = document.getElementById('taskModal');
                const insertSelect = document.getElementById('m-insert');
                
                insertSelect.innerHTML = '<option value="end">-- End of List --</option>';
                if(projectData.length > 0) {
                    projectData.forEach((t, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        const safeName = (t.name || "Task").substring(0,30);
                        opt.text = `After: [${t.id}] ${safeName}...`;
                        insertSelect.appendChild(opt);
                    });
                }

                editingId = id;
                insertTargetId = null;
                isCreatingSubtask = false;

                if (mode === 'edit' && id) {
                    document.getElementById('modalTitle').innerText = "Edit Task";
                    document.getElementById('div-insert').classList.add('hidden');
                    const task = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = task.name;
                    document.getElementById('m-type').value = task.type;
                    document.getElementById('m-parent').value = task.parent || '';
                    document.getElementById('m-depType').value = task.depType || 'FS';
                    document.getElementById('m-start').value = task.start;
                    document.getElementById('m-dur').value = task.dur;
                    document.getElementById('m-pct').value = task.pct;
                    document.getElementById('m-indent').value = task.indent || 0;
                } else if (mode === 'subtask' && id) {
                    isCreatingSubtask = true;
                    insertTargetId = id;
                    document.getElementById('modalTitle').innerText = "Add Subtask";
                    document.getElementById('div-insert').classList.add('hidden');
                    const parentTask = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = ""; 
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                    document.getElementById('m-indent').value = (parentTask.indent || 0) + 1;
                    editingId = null;
                } else if (mode === 'insert' && id) {
                    insertTargetId = id;
                    document.getElementById('modalTitle').innerText = "Insert Task Below";
                    document.getElementById('div-insert').classList.add('hidden');
                    const siblingTask = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = id; 
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                    document.getElementById('m-indent').value = siblingTask.indent || 0;
                    editingId = null;
                } else {
                    document.getElementById('modalTitle').innerText = "Add New Task";
                    document.getElementById('div-insert').classList.remove('hidden');
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = "";
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                    document.getElementById('m-indent').value = "0";
                }
                toggleDurationState();
                modal.classList.remove('hidden');
            } catch (err) { console.error(err); alert("Error opening modal: " + err.message); }
        }

        function closeModal() { document.getElementById('taskModal').classList.add('hidden'); }

        function saveTask() {
            try {
                const name = document.getElementById('m-name').value || "New Task";
                const type = document.getElementById('m-type').value;
                let dur = parseInt(document.getElementById('m-dur').value) || 0;
                if (type === 'Milestone') dur = 0; 
                
                const start = document.getElementById('m-start').value || new Date().toISOString().split('T')[0];
                const pct = parseInt(document.getElementById('m-pct').value) || 0;
                const parentInput = document.getElementById('m-parent').value;
                const parent = parentInput ? parseInt(parentInput) : null;
                const depType = document.getElementById('m-depType').value;
                const indent = parseInt(document.getElementById('m-indent').value) || 0;

                if (editingId) {
                    const task = projectData.find(t => t.id === editingId);
                    if (task) Object.assign(task, { name, type, dur, start, pct, parent, depType, indent });
                } else {
                    const maxId = projectData.length > 0 ? Math.max(...projectData.map(t => t.id)) : 0;
                    const newId = maxId + 1;
                    
                    const newTask = { id: newId, name, type, dur, start, pct, parent, depType, baseStart: start, baseDur: dur, indent };
                    
                    if (insertTargetId) {
                        const idx = projectData.findIndex(t => t.id === insertTargetId);
                        if (idx !== -1) {
                            projectData.splice(idx + 1, 0, newTask);
                        } else {
                            projectData.push(newTask);
                        }
                    } else {
                        const insertVal = document.getElementById('m-insert').value;
                        if (insertVal === "end") projectData.push(newTask);
                        else projectData.splice(parseInt(insertVal) + 1, 0, newTask);
                    }
                }
                refreshView();
                closeModal();
            } catch(err) { console.error(err); alert("Error saving task"); }
        }

        function deleteTask(id) {
            if(confirm("Delete Task?")) {
                const idx = projectData.findIndex(t => t.id === id);
                if (idx > -1) { 
                    // Orphan prevention: Update any children of this task to have no parent
                    projectData.forEach(t => { if(t.parent === id) t.parent = null; });
                    projectData.splice(idx, 1); 
                    refreshView(); 
                }
            }
        }

        // --- INIT & RENDER ---
        window.addEventListener('load', () => {
            initData();
            refreshView();
            enableColumnResizing(); // Initialize column resizing
            enablePanelResizing();  // Initialize panel resizing
            
            const grid = document.getElementById('grid-scroll');
            const chart = document.getElementById('chart-scroll');
            const header = document.getElementById('axis-wrapper');
            let isSyncing = false;

            const syncVertical = (source, target) => {
                if(!isSyncing) { isSyncing = true; target.scrollTop = source.scrollTop; isSyncing = false; }
            };
            grid.onscroll = () => syncVertical(grid, chart);
            chart.onscroll = () => {
                syncVertical(chart, grid);
                header.style.left = `-${chart.scrollLeft}px`; 
            };
        });

        function refreshView() {
            calculateSchedule();
            calculateCriticalPath();
            renderTable();
            try { renderChart(); } catch(e) { console.warn("Chart render skipped", e); }
            document.getElementById('task-count').innerText = projectData.length;
        }

        function renderTable() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            projectData.forEach((task, index) => {
                if(!isRowVisible(index)) return;

                const endStr = new Date(new Date(task.start).getTime() + (task.dur * 86400000)).toISOString().split('T')[0];
                const row = document.createElement('tr');
                row.className = 'gantt-row hover:bg-slate-50 transition-colors group';
                
                const paddingLeft = (task.indent || 0) * 20 + 8;
                const isParent = projectData.some(t => t.indent > task.indent && projectData.indexOf(t) > index);
                const toggleIcon = collapsedParents.has(task.id) ? '+' : 'âˆ’';
                const toggleVisibility = isParent || (index < projectData.length -1 && projectData[index+1].indent > task.indent) ? 'visible' : 'hidden';

                const isDateDisabled = task.parent !== null;
                const dateClass = isDateDisabled ? "bg-slate-50 text-slate-400 cursor-not-allowed" : "editable";
                const dateClick = isDateDisabled ? "" : `onclick="makeEditable(this, ${task.id}, 'start')"`;

                row.innerHTML = `
                    <td class="font-mono text-xs text-slate-400 font-bold text-center border-r border-slate-100">${task.id}</td>
                    <td class="border-r border-slate-100 relative editable" style="height:40px;">
                        <div class="flex items-center h-full">
                            <span class="toggle-btn" style="visibility:${toggleVisibility}; margin-left:${paddingLeft - 16}px" onclick="toggleCollapse(${task.id}); event.stopPropagation();">${toggleIcon}</span>
                            <div class="truncate-text font-medium text-slate-700 text-xs flex-grow" style="padding-left: 4px;" onclick="openTaskModal(${task.id})">${task.name}</div>
                        </div>
                    </td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'parent')">${task.parent || '-'}</td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'depType')">${task.depType || 'FS'}</td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'dur')">${task.dur}d</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100 whitespace-nowrap ${dateClass}" ${dateClick}>${task.start}</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100 bg-slate-50 text-slate-400 cursor-not-allowed whitespace-nowrap" title="Auto-Calculated">${endStr}</td>
                    <td class="text-center border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'pct')">
                        <span class="text-[9px] font-bold text-slate-400">${task.pct}%</span>
                    </td>
                    <td class="text-center border-r border-slate-100">
                        <div class="flex items-center justify-center h-full gap-1">
                            <button onclick="openTaskModal(${task.id}, 'edit')" class="btn-icon" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                            <button onclick="openTaskModal(${task.id}, 'subtask')" class="btn-icon text-indigo-600 font-bold" title="Add Child">â†³</button>
                            <button onclick="modifyIndent(${task.id}, -1)" class="btn-icon" title="Outdent">&larr;</button>
                            <button onclick="modifyIndent(${task.id}, 1)" class="btn-icon" title="Indent">&rarr;</button>
                            <button onclick="deleteTask(${task.id})" class="btn-icon-danger" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function makeEditable(cell, id, field) {
            if (cell.querySelector('input, select') || cell.classList.contains('editing')) return;
            const task = projectData.find(t => t.id === id);
            if (!task) return;

            const currentValue = task[field];
            cell.classList.add('editing');
            
            let inputHTML = '';
             if (field === 'start') {
                inputHTML = `<input type="date" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else if (field === 'depType') {
                inputHTML = `<select onblur="commitEdit(${id}, '${field}', this.value)" class="w-full text-xs bg-slate-100">
                    <option value="FS" ${currentValue==='FS'?'selected':''}>FS</option>
                    <option value="SS" ${currentValue==='SS'?'selected':''}>SS</option>
                    <option value="FF" ${currentValue==='FF'?'selected':''}>FF</option>
                    <option value="SF" ${currentValue==='SF'?'selected':''}>SF</option>
                </select>`;
            } else if (field === 'name') {
                inputHTML = `<input type="text" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else {
                inputHTML = `<input type="number" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            }
            
            cell.innerHTML = inputHTML;
            const input = cell.querySelector('input, select');
            if(input) input.focus();
        }

        function commitEdit(id, field, value) {
            const task = projectData.find(t => t.id === id);
            if (!task) return;
            
            if (field === 'dur') task.dur = parseInt(value) || 0;
            else if (field === 'pct') task.pct = Math.min(100, Math.max(0, parseInt(value) || 0));
            else if (field === 'parent') task.parent = value ? parseInt(value) : null;
            else if (field === 'depType') task.depType = value;
            else if (field === 'start') task.start = value;
            else task[field] = value;
            
            refreshView();
        }

        let chartInstance = null;
        let axisInstance = null;

        function renderChart() {
            if(projectData.length === 0) {
                if(chartInstance) chartInstance.destroy();
                if(axisInstance) axisInstance.destroy();
                return;
            }

            const visibleTasks = [];
            projectData.forEach((t, i) => { if(isRowVisible(i)) visibleTasks.push(t); });

            const ROW_HEIGHT = 36; 
            document.getElementById('chart-container').style.height = `${visibleTasks.length * ROW_HEIGHT}px`;
            
            const ctx = document.getElementById('ganttCanvas').getContext('2d');
            const axisCtx = document.getElementById('axisCanvas').getContext('2d');

            if (chartInstance) chartInstance.destroy();
            if (axisInstance) axisInstance.destroy();

            const baselineData = visibleTasks.map(t => {
                if(!showBaseline) return { x: null, y: `Row ${t.id}` };
                const s = new Date(t.baseStart);
                const e = new Date(s.getTime() + ((t.baseDur || 0.5) * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}` };
            });

            const actualData = visibleTasks.map(t => {
                const s = new Date(t.start);
                const displayDur = t.type === 'Milestone' ? 0.5 : t.dur;
                const e = new Date(s.getTime() + (displayDur * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}`, status: t.pct };
            });

            // Width & Scale Calculation based on View Mode
            const minDate = new Date("2026-01-08");
            let maxDate = minDate;
            projectData.forEach(t => {
                const end = new Date(t.start);
                end.setDate(end.getDate() + (t.dur || 1));
                if (end > maxDate) maxDate = end;
            });
            maxDate = new Date(maxDate.getTime() + (45 * 86400000)); 

            const daysSpan = (maxDate - minDate) / 86400000;
            
            let pixelsPerDay = 20;
            let timeUnit = 'week';
            
            if (viewMode === '2week') {
                pixelsPerDay = 10; // More compressed
                timeUnit = 'week';
            } else if (viewMode === 'month') {
                pixelsPerDay = 4; // Very compressed
                timeUnit = 'month';
            }

            const requiredWidth = Math.max(document.getElementById('chart-scroll').clientWidth, daysSpan * pixelsPerDay);

            document.getElementById('chart-container').style.width = `${requiredWidth}px`;
            document.getElementById('axis-wrapper').style.width = `${requiredWidth}px`;

            const sharedOptions = {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                layout: { padding: { left: 0, right: 20 } },
                plugins: { legend: { display: false }, tooltip: { enabled: true } },
                scales: {
                    x: { 
                        type: 'time', time: { unit: timeUnit }, 
                        min: minDate.valueOf(), max: maxDate.valueOf(),
                        position: 'top', 
                        grid: { color: '#E2E8F0' }, 
                        ticks: { font: { size: 10, weight: 'bold' }, color: '#64748B', maxRotation: 0, autoSkip: true } 
                    },
                    y: { display: false, grid: { display: false } }
                }
            };

            // Main Chart
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: visibleTasks.map(t => `Row ${t.id}`),
                    datasets: [
                        { label: 'Baseline', data: baselineData, backgroundColor: '#94A3B8', barThickness: 4, grouped: false, order: 1 },
                        { label: 'Actual', data: actualData, backgroundColor: (ctx) => {
                            const dataIndex = ctx.dataIndex;
                            if (dataIndex === undefined || dataIndex < 0) return '#CBD5E1';
                            const task = visibleTasks[dataIndex];
                            if (task.type === 'Milestone') return 'rgba(0,0,0,0)'; 
                            const pct = ctx.raw?.status;
                            if(pct === 100) return '#10B981'; if(pct > 0) return '#F59E0B'; return '#CBD5E1';
                        }, borderRadius: 3, barPercentage: 0.6, grouped: false, order: 0 }
                    ]
                },
                options: {
                    ...sharedOptions,
                    layout: { padding: { top: 0, bottom: 0, left: 0, right: 20 } },
                    scales: {
                        x: { 
                            // FIX: Hide ticks on the main chart to prevent "Double Header" effect
                            type: 'time', time: { unit: timeUnit }, 
                            min: minDate.valueOf(), max: maxDate.valueOf(),
                            position: 'top', 
                            grid: { color: '#E2E8F0' }, 
                            ticks: { display: false } 
                        },
                        y: { display: false, grid: { display: false } }
                    }
                },
                plugins: [{
                    id: 'weekendHighlighter',
                    beforeDraw(chart) {
                        // Only draw weekends if we aren't in month view (too cluttered)
                        if (viewMode === 'month') return;

                        const { ctx, scales: { x } } = chart;
                        const start = new Date(x.min);
                        const end = new Date(x.max);
                        
                        ctx.fillStyle = 'rgba(241, 245, 249, 0.4)'; // Slight gray for weekends
                        
                        // Loop days
                        let current = new Date(start);
                        while(current <= end) {
                            const day = current.getDay();
                            if(day === 0 || day === 6) { // Sun or Sat
                                const xStart = x.getPixelForValue(current.getTime());
                                const nextDay = new Date(current); nextDay.setDate(nextDay.getDate() + 1);
                                const xEnd = x.getPixelForValue(nextDay.getTime());
                                ctx.fillRect(xStart, 0, xEnd - xStart, chart.height);
                            }
                            current.setDate(current.getDate() + 1);
                        }
                    }
                },
                {
                    id: 'dependencyLines',
                    // Draw lines BEFORE datasets so they are behind the bars
                    beforeDatasetsDraw(chart) {
                        const { ctx } = chart;
                        const meta = chart.getDatasetMeta(1); // Actual data
                        const idToIndex = {}; visibleTasks.forEach((t, i) => idToIndex[t.id] = i);
                        
                        ctx.save(); ctx.lineJoin = 'round'; ctx.lineCap = 'round';
                        
                        visibleTasks.forEach((task, index) => {
                            if (task.parent && idToIndex[task.parent] !== undefined) {
                                const pIdx = idToIndex[task.parent];
                                // Skip drawing if parent is hidden (collapsed) or logic implies root
                                if (task.type === 'Milestone' || visibleTasks[pIdx].type === 'Milestone') return;

                                const pBar = meta.data[pIdx];
                                const cBar = meta.data[index];
                                if (!pBar || !cBar) return;

                                const isCrit = criticalPathSet.has(task.id) && criticalPathSet.has(task.parent);

                                ctx.strokeStyle = isCrit ? '#9333EA' : '#94A3B8';
                                ctx.lineWidth = isCrit ? 2 : 1;
                                if (!isCrit) ctx.setLineDash([2, 4]); else ctx.setLineDash([]);

                                const startY = pBar.y; const endY = cBar.y;
                                
                                // Simple FS logic for drawing (Connect Right of parent to Left of child)
                                const startX = pBar.x; 
                                const endX = cBar.base; 

                                ctx.beginPath();
                                ctx.moveTo(startX, startY);
                                const cp1x = startX + 15; const cp2x = endX - 15;
                                ctx.bezierCurveTo(cp1x, startY, cp2x, endY, endX, endY);
                                ctx.stroke();
                                
                                // Arrowhead
                                ctx.beginPath();
                                ctx.fillStyle = ctx.strokeStyle;
                                ctx.moveTo(endX, endY);
                                ctx.lineTo(endX - 5, endY - 3);
                                ctx.lineTo(endX - 5, endY + 3);
                                ctx.fill();
                            }
                        });

                        // Draw Milestones (Diamonds)
                        visibleTasks.forEach((task, index) => {
                            if (task.type === 'Milestone') {
                                const bar = meta.data[index];
                                if (!bar) return;
                                const x = bar.base; 
                                const y = bar.y;
                                const size = 6;
                                ctx.beginPath();
                                ctx.fillStyle = task.pct === 100 ? '#10B981' : '#F59E0B';
                                ctx.moveTo(x, y - size);
                                ctx.lineTo(x + size, y);
                                ctx.lineTo(x, y + size);
                                ctx.lineTo(x - size, y);
                                ctx.fill();
                                ctx.stroke();
                            }
                        });
                        ctx.restore();
                    }
                }]
            });
            
            // Axis Chart (Header)
            axisInstance = new Chart(axisCtx, {
                type: 'bar',
                data: { labels: [''], datasets: [] },
                options: {
                    ...sharedOptions,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { 
                            type: 'time', time: { unit: timeUnit }, 
                            min: minDate.valueOf(), max: maxDate.valueOf(),
                            position: 'top', 
                            grid: { color: '#E2E8F0' }, 
                            ticks: { font: { size: 10, weight: 'bold' }, color: '#64748B', maxRotation: 0, autoSkip: true } 
                        },
                        y: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
