<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD-WAN Gantt Pro + RAID</title>
    <!-- Tailwind CSS (Dev Script) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Date Adapter (Version Pinned for Stability) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- SheetJS for Excel Export/Import -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F1F5F9; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Alignment Constants */
        :root {
            --row-height: 36px; /* Compact row height */
            --header-height: 40px;
        }

        /* FIXED: Removed display:flex to allow table-layout to control widths */
        .gantt-row { height: var(--row-height); border-bottom: 1px solid #F1F5F9; box-sizing: border-box; }
        .gantt-row.hidden-row { display: none; } /* For collapsing */

        .gantt-header { height: var(--header-height); background: #F8FAFC; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #E2E8F0; }
        
        /* FIXED: Added table-layout: fixed to strictly obey column widths */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        th { 
            white-space: nowrap; font-size: 0.65rem; color: #64748B; 
            text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; text-align: left; padding: 0 4px;
            height: var(--header-height); background: #F8FAFC;
            position: relative; /* For resizer positioning */
        }
        td { 
            white-space: nowrap; font-size: 0.7rem; color: #334155; 
            padding: 0 4px; vertical-align: middle; height: var(--row-height);
            overflow: hidden; text-overflow: ellipsis;
        }
        
        /* Column Resizer Styles */
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            touch-action: none;
            z-index: 10;
        }
        .resizer:hover, .resizing {
            background-color: #6366F1; /* Indigo-500 highlight on hover/drag */
        }

        /* Editable Cells */
        .editable { cursor: pointer; transition: background-color 0.15s; }
        .editable:hover { background-color: #F1F5F9; color: #4F46E5; }
        .editing { padding: 0 !important; }
        .editing input, .editing select { width: 100%; height: 100%; border: 2px solid #6366F1; padding: 0 4px; font-size: 0.7rem; outline: none; background: #EEF2FF; }

        .truncate-text { max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        .btn-icon { padding: 2px; border-radius: 4px; color: #94A3B8; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon:hover { color: #6366F1; background-color: #EEF2FF; }

        .btn-icon-green { padding: 2px; border-radius: 4px; color: #10B981; font-weight: bold; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon-green:hover { color: #047857; background-color: #ECFDF5; }

        .btn-icon-danger { padding: 2px; border-radius: 4px; color: #94A3B8; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon-danger:hover { color: #F43F5E; background-color: #FFF1F2; }

        .toggle-btn { cursor: pointer; display: inline-block; width: 12px; text-align: center; color: #64748B; font-weight: bold; user-select: none; font-size: 10px; }
        .toggle-btn:hover { color: #4F46E5; }

        /* RAID Tables Specifics */
        .raid-table th { background-color: #F1F5F9; color: #475569; cursor: pointer; user-select: none; }
        .raid-table th:hover { background-color: #E2E8F0; }
        .raid-row:nth-child(even) { background-color: #FAFAFA; }
        .sort-icon { display: inline-block; margin-left: 4px; width: 10px; font-weight: normal; color: #94A3B8; }
        
        /* Modal Styles */
        .modal-overlay { 
            background-color: rgba(0, 0, 0, 0.2); 
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="flex-none bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center z-30 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">P</div>
            <div>
                <h1 class="text-base font-bold text-slate-900 leading-tight">SD-WAN Project Plan</h1>
                <p class="text-[10px] text-slate-500">Pro Gantt | <span id="task-count">0</span> Items</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            
            <!-- Contextual Controls: Schedule -->
            <div id="controls-schedule" class="flex items-center gap-3">
                <div class="flex items-center gap-2 mr-2">
                    <button onclick="window.loadTemplate()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>
                        Template
                    </button>
                    <!-- Export Excel -->
                    <button onclick="window.exportProjectExcel()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Export Excel
                    </button>
                    <!-- Import Excel -->
                    <button onclick="document.getElementById('fileImport').click()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        Import Excel
                    </button>
                    <input type="file" id="fileImport" accept=".xlsx" class="hidden" onchange="window.importProjectExcel(this)">
                </div>

                <div class="flex items-center gap-2 mr-2 border-l border-r border-slate-200 px-2">
                    <select onchange="window.setViewMode(this.value)" class="text-[10px] font-bold uppercase text-slate-600 bg-white border border-slate-200 hover:border-indigo-200 px-2 py-1 rounded transition-colors outline-none cursor-pointer">
                        <option value="week" selected>1 Week</option>
                        <option value="2week">2 Weeks</option>
                        <option value="month">1 Month</option>
                    </select>

                    <button onclick="window.setBaseline()" class="text-[10px] font-bold uppercase text-slate-500 hover:text-rose-600 bg-slate-50 hover:bg-rose-50 px-2 py-1 rounded transition-colors" title="Overwrite current baseline with active schedule">
                        Re-Base
                    </button>
                    <label class="flex items-center gap-1 cursor-pointer select-none">
                        <input type="checkbox" id="showBaselineToggle" checked onchange="window.toggleBaseline()" class="form-checkbox h-3 w-3 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                        <span class="text-[10px] font-bold uppercase text-slate-500">Base</span>
                    </label>
                </div>

                <button onclick="window.openTaskModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Task
                </button>
            </div>

            <!-- Contextual Controls: RAID (Hidden by default) -->
            <div id="controls-raid" class="hidden flex items-center gap-3">
                <button onclick="window.addRAIDItem()" id="btn-add-raid" class="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Item
                </button>
            </div>

            <!-- Global Controls -->
            <button onclick="window.openReportModal()" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Report
            </button>

            <button onclick="window.openAIModal()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white text-[10px] font-bold py-1.5 px-3 rounded shadow-sm flex items-center gap-1 transition-all border border-indigo-400/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                AI Assistant
            </button>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="flex border-b border-slate-200 bg-white px-4 pt-1 shadow-[0_2px_4px_rgba(0,0,0,0.02)] z-20">
        <button onclick="window.switchTab('schedule')" id="tab-schedule" class="px-4 py-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors border-indigo-600 text-indigo-600">Schedule</button>
        <button onclick="window.switchTab('risks')" id="tab-risks" class="px-4 py-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors border-transparent text-slate-500 hover:text-slate-700">Risks</button>
        <button onclick="window.switchTab('issues')" id="tab-issues" class="px-4 py-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors border-transparent text-slate-500 hover:text-slate-700">Issues</button>
        <!-- UPDATED: Renamed to Change Control -->
        <button onclick="window.switchTab('changes')" id="tab-changes" class="px-4 py-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors border-transparent text-slate-500 hover:text-slate-700">Change Control</button>
        <button onclick="window.switchTab('comms')" id="tab-comms" class="px-4 py-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors border-transparent text-slate-500 hover:text-slate-700">Comms Plan</button>
        <button onclick="window.switchTab('actions')" id="tab-actions" class="px-4 py-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors border-transparent text-slate-500 hover:text-slate-700">Actions</button>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-grow flex overflow-hidden relative">
        
        <!-- VIEW: SCHEDULE (Split Pane) -->
        <div id="view-schedule" class="flex-grow flex overflow-hidden w-full h-full absolute inset-0 bg-white">
            <!-- LEFT: Data Table -->
            <div id="left-panel" class="flex-none border-r border-slate-200 bg-white flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20" style="width: 35%; min-width: 200px;">
                <div class="flex-grow overflow-auto" id="grid-scroll">
                    <table class="w-full min-w-[800px]">
                        <thead class="gantt-header">
                            <tr>
                                <th class="w-8 text-center">ID</th>
                                <th>Name</th>
                                <th class="w-10 text-center" title="Dependency">Dep</th>
                                <th class="w-12 text-center" title="Dependency Type">Typ</th>
                                <th class="w-10 text-center">Dur</th>
                                <th class="w-24">Start</th>
                                <th class="w-24">Finish</th>
                                <th class="w-10 text-center">%</th>
                                <th class="w-10 text-center" title="Track as Action">Track</th>
                                <th class="w-28 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="grid-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Resizer Handle -->
            <div id="panel-resizer" class="w-1 bg-slate-200 hover:bg-indigo-500 cursor-col-resize z-30 transition-colors flex-none"></div>

            <!-- RIGHT: Gantt Chart -->
            <div class="flex-grow flex flex-col bg-white relative min-w-0 overflow-hidden">
                <div id="chart-header-container" class="flex-none overflow-hidden bg-slate-50 border-b border-slate-200" style="height: 40px;">
                     <div id="axis-wrapper" class="relative"> 
                         <canvas id="axisCanvas"></canvas>
                     </div>
                </div>
                <div class="flex-grow overflow-auto" id="chart-scroll">
                    <div id="chart-container" class="relative">
                        <canvas id="ganttCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: RISKS (Amber) -->
        <div id="view-risks" class="hidden w-full h-full absolute inset-0 bg-slate-50 p-6 overflow-auto">
            <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col min-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-200 bg-amber-50 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-bold text-amber-800">Risk Register</h2>
                        <span class="text-xs text-amber-600 font-medium bg-amber-100 px-2 py-1 rounded">PRINCE2 Compliant</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="btn-gtt-view-risks" onclick="window.toggleGTTView('risks')" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-amber-600 bg-amber-600 text-white shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                            GTT Mode
                        </button>
                        <div class="h-4 w-px bg-amber-200 mx-1"></div>
                        <select id="status-filter-risks" onchange="window.applyRAIDFilter('risks')" class="px-2 py-1.5 text-xs border border-amber-200 rounded focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white cursor-pointer">
                            <option value="All">All Categories</option>
                        </select>
                        <input id="search-text-risks" type="text" placeholder="Search risks..." onkeyup="window.applyRAIDFilter('risks')" class="px-3 py-1.5 text-xs border border-amber-200 rounded focus:outline-none focus:ring-2 focus:ring-amber-500 w-48">
                    </div>
                </div>
                <table class="w-full text-left border-collapse raid-table">
                    <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                        <tr>
                            <th class="p-3 border-b w-12 text-center" onclick="window.sortRAID('risks', 'id')">Number <span id="sort-icon-risks-id" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-10 text-center" title="Toggle Internal/Public Visibility">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                            </th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('risks', 'category')">Category <span id="sort-icon-risks-category" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b" onclick="window.sortRAID('risks', 'details')">Risk Details <span id="sort-icon-risks-details" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-48" onclick="window.sortRAID('risks', 'mitigation')">Mitigating Action <span id="sort-icon-risks-mitigation" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('risks', 'notes')">Notes <span id="sort-icon-risks-notes" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('risks', 'raised')">Raised <span id="sort-icon-risks-raised" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('risks', 'owner')">Owner <span id="sort-icon-risks-owner" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-20" onclick="window.sortRAID('risks', 'level')">Level <span id="sort-icon-risks-level" class="sort-icon sort-icon-risks">⇅</span></th>
                            <th class="p-3 border-b w-16 text-center">Act</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-risks"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: ISSUES (Red) -->
        <div id="view-issues" class="hidden w-full h-full absolute inset-0 bg-slate-50 p-6 overflow-auto">
            <div class="max-w-full mx-auto bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col min-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-200 bg-red-50 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-bold text-red-800">Issue Register</h2>
                        <span class="text-xs text-red-600 font-medium bg-red-100 px-2 py-1 rounded">Tracking</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="btn-gtt-view-issues" onclick="window.toggleGTTView('issues')" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-red-600 bg-red-600 text-white shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                            GTT Mode
                        </button>
                        <div class="h-4 w-px bg-red-200 mx-1"></div>
                        <select id="status-filter-issues" onchange="window.applyRAIDFilter('issues')" class="px-2 py-1.5 text-xs border border-red-200 rounded focus:outline-none focus:ring-2 focus:ring-red-500 bg-white cursor-pointer">
                            <option value="All">All Status</option>
                        </select>
                        <input id="search-text-issues" type="text" placeholder="Search..." onkeyup="window.applyRAIDFilter('issues')" class="px-3 py-1.5 text-xs border border-red-200 rounded focus:outline-none focus:ring-2 focus:ring-red-500 w-48">
                    </div>
                </div>
                <table class="w-full text-left border-collapse raid-table">
                    <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                        <tr>
                            <!-- UPDATED Headers -->
                            <th class="p-3 border-b w-12 text-center" onclick="window.sortRAID('issues', 'id')">Number <span id="sort-icon-issues-id" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-10 text-center" title="Toggle Internal/Public Visibility">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                            </th>
                            <th class="p-3 border-b w-28" onclick="window.sortRAID('issues', 'category')">Category <span id="sort-icon-issues-category" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('issues', 'owner')">Issue Assigned to <span id="sort-icon-issues-owner" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b min-w-[200px]" onclick="window.sortRAID('issues', 'desc')">Description <span id="sort-icon-issues-desc" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b min-w-[200px]" onclick="window.sortRAID('issues', 'currentStatus')">Current Status <span id="sort-icon-issues-currentStatus" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('issues', 'status')">Status <span id="sort-icon-issues-status" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('issues', 'raised')">Raised <span id="sort-icon-issues-raised" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('issues', 'target')">Target <span id="sort-icon-issues-target" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('issues', 'updated')">Updated <span id="sort-icon-issues-updated" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('issues', 'completed')">Completed <span id="sort-icon-issues-completed" class="sort-icon sort-icon-issues">⇅</span></th>
                            <th class="p-3 border-b w-16 text-center">Act</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-issues"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: CHANGES -->
        <div id="view-changes" class="hidden w-full h-full absolute inset-0 bg-slate-50 p-6 overflow-auto">
            <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col min-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-200 bg-blue-50 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <!-- UPDATED: Title -->
                        <h2 class="text-lg font-bold text-blue-800">Change Control</h2>
                        <span class="text-xs text-blue-600 font-medium bg-blue-100 px-2 py-1 rounded">Change Control</span>
                    </div>
                    <div class="flex items-center gap-3">
                         <button id="btn-gtt-view-changes" onclick="window.toggleGTTView('changes')" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-blue-600 bg-blue-600 text-white shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                            GTT Mode
                        </button>
                        <div class="h-4 w-px bg-blue-200 mx-1"></div>
                         <select id="status-filter-changes" onchange="window.applyRAIDFilter('changes')" class="px-2 py-1.5 text-xs border border-blue-200 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer">
                            <option value="All">All Status</option>
                        </select>
                        <input id="search-text-changes" type="text" placeholder="Search..." onkeyup="window.applyRAIDFilter('changes')" class="px-3 py-1.5 text-xs border border-blue-200 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">
                    </div>
                </div>
                <table class="w-full text-left border-collapse raid-table">
                    <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                        <tr>
                            <!-- UPDATED: Headers matching image -->
                            <th class="p-3 border-b w-12 text-center" onclick="window.sortRAID('changes', 'id')">Number <span id="sort-icon-changes-id" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-10 text-center" title="Toggle Internal/Public Visibility">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                            </th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('changes', 'category')">Category <span id="sort-icon-changes-category" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('changes', 'owner')">Assigned to <span id="sort-icon-changes-owner" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b" onclick="window.sortRAID('changes', 'desc')">Description <span id="sort-icon-changes-desc" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-40" onclick="window.sortRAID('changes', 'impact')">Impact / Status <span id="sort-icon-changes-impact" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('changes', 'status')">Status <span id="sort-icon-changes-status" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('changes', 'raised')">Raised <span id="sort-icon-changes-raised" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('changes', 'target')">Target <span id="sort-icon-changes-target" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('changes', 'updated')">Updated <span id="sort-icon-changes-updated" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-24" onclick="window.sortRAID('changes', 'completed')">Complete <span id="sort-icon-changes-completed" class="sort-icon sort-icon-changes">⇅</span></th>
                            <th class="p-3 border-b w-20 text-center">Act</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-changes"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: COMMS -->
        <div id="view-comms" class="hidden w-full h-full absolute inset-0 bg-slate-50 p-6 overflow-auto">
            <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col min-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-200 bg-indigo-50 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-bold text-indigo-800">Communication Plan</h2>
                        <span class="text-xs text-indigo-600 font-medium bg-indigo-100 px-2 py-1 rounded">Stakeholders</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="btn-gtt-view-comms" onclick="window.toggleGTTView('comms')" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-indigo-600 bg-indigo-600 text-white shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                            GTT Mode
                        </button>
                        <div class="h-4 w-px bg-indigo-200 mx-1"></div>
                        <input id="search-text-comms" type="text" placeholder="Search comms..." onkeyup="window.applyRAIDFilter('comms')" class="px-3 py-1.5 text-xs border border-indigo-200 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 w-48">
                    </div>
                </div>
                <table class="w-full text-left border-collapse raid-table">
                    <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                        <tr>
                            <th class="p-3 border-b w-12 text-center" onclick="window.sortRAID('comms', 'id')">ID <span id="sort-icon-comms-id" class="sort-icon sort-icon-comms">⇅</span></th>
                            <th class="p-3 border-b w-10 text-center" title="Toggle Internal/Public Visibility">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                            </th>
                            <th class="p-3 border-b w-48" onclick="window.sortRAID('comms', 'stake')">Stakeholder / Audience <span id="sort-icon-comms-stake" class="sort-icon sort-icon-comms">⇅</span></th>
                            <th class="p-3 border-b" onclick="window.sortRAID('comms', 'info')">Information Required <span id="sort-icon-comms-info" class="sort-icon sort-icon-comms">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('comms', 'freq')">Frequency <span id="sort-icon-comms-freq" class="sort-icon sort-icon-comms">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('comms', 'method')">Method <span id="sort-icon-comms-method" class="sort-icon sort-icon-comms">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('comms', 'provider')">Provider <span id="sort-icon-comms-provider" class="sort-icon sort-icon-comms">⇅</span></th>
                            <th class="p-3 border-b w-20 text-center">Act</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-comms"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: ACTIONS -->
        <div id="view-actions" class="hidden w-full h-full absolute inset-0 bg-slate-50 p-6 overflow-auto">
            <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col min-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-200 bg-emerald-50 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-bold text-emerald-800">Action Items</h2>
                        <span class="text-xs text-emerald-600 font-medium bg-emerald-100 px-2 py-1 rounded">Project Actions</span>
                    </div>
                     <div class="flex items-center gap-3">
                        <button id="btn-gtt-view-actions" onclick="window.toggleGTTView('actions')" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-emerald-600 bg-emerald-600 text-white shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                            GTT Mode
                        </button>
                        <div class="h-4 w-px bg-emerald-200 mx-1"></div>
                        <select id="status-filter-actions" onchange="window.applyRAIDFilter('actions')" class="px-2 py-1.5 text-xs border border-emerald-200 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white cursor-pointer">
                            <option value="All">All Status</option>
                        </select>
                        <input id="search-text-actions" type="text" placeholder="Search..." onkeyup="window.applyRAIDFilter('actions')" class="px-3 py-1.5 text-xs border border-emerald-200 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500 w-48">
                    </div>
                </div>
                <table class="w-full text-left border-collapse raid-table">
                    <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                        <tr>
                            <th class="p-3 border-b w-12 text-center" onclick="window.sortRAID('actions', 'id')">ID <span id="sort-icon-actions-id" class="sort-icon sort-icon-actions">⇅</span></th>
                            <th class="p-3 border-b w-10 text-center" title="Toggle Internal/Public Visibility">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                            </th>
                            <th class="p-3 border-b" onclick="window.sortRAID('actions', 'desc')">Action Description <span id="sort-icon-actions-desc" class="sort-icon sort-icon-actions">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('actions', 'owner')">Owner <span id="sort-icon-actions-owner" class="sort-icon sort-icon-actions">⇅</span></th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('actions', 'due')">Due Date <span id="sort-icon-actions-due" class="sort-icon sort-icon-actions">⇅</span></th>
                            <th class="p-3 border-b w-32 text-slate-400" title="Last Updated">Updated</th>
                            <th class="p-3 border-b w-32" onclick="window.sortRAID('actions', 'status')">Status <span id="sort-icon-actions-status" class="sort-icon sort-icon-actions">⇅</span></th>
                            <th class="p-3 border-b w-20 text-center">Act</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-actions"></tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- NEW: Custom Delete Confirmation Modal (Bypasses window.confirm restrictions) -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-80 p-6 border border-slate-200">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-slate-900">Delete Item?</h3>
                <div class="mt-2">
                    <p class="text-sm text-slate-500">Are you sure you want to delete this item? This action cannot be undone.</p>
                </div>
            </div>
            <div class="mt-5 flex justify-center gap-3">
                <button onclick="window.closeDeleteModal()" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50">Cancel</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal (Only for Add New) -->
    <div id="taskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 m-4 border border-slate-200">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Add New Task</h3>
                <button onclick="window.closeModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="p-6 space-y-4 bg-white/95">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Task Name</label>
                    <input type="text" id="m-name" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <input type="hidden" id="m-indent" value="0">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                        <select id="m-type" onchange="window.toggleDurationState()" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="Task">Task</option>
                            <option value="Milestone">Milestone</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Duration (Days)</label>
                        <input type="number" id="m-dur" value="1" min="0" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <h4 class="text-xs font-bold text-indigo-800 uppercase mb-2">Dependency Logic</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-1">Predecessor ID</label>
                            <input type="number" id="m-parent" placeholder="e.g. 10" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-1">Dep. Type</label>
                            <select id="m-depType" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                <option value="FS">Finish-to-Start (FS)</option>
                                <option value="SS">Start-to-Start (SS)</option>
                                <option value="FF">Finish-to-Finish (FF)</option>
                                <option value="SF">Start-to-Finish (SF)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                        <input type="date" id="m-start" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">% Complete</label>
                        <input type="number" id="m-pct" value="0" min="0" max="100" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                
                <div id="div-insert" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Insert After</label>
                    <select id="m-insert" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                        <option value="end">-- End of List --</option>
                    </select>
                </div>
                
                <input type="hidden" id="m-finish"> 
            </div>

            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="window.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="window.saveTask()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 m-4 border border-slate-200">
            <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-red-800">Report Issue / Request</h3>
                <button onclick="window.closeReportModal()" class="text-red-400 hover:text-red-600">&times;</button>
            </div>
            <div class="p-6 space-y-4 bg-white">
                <p class="text-sm text-slate-600 leading-relaxed">
                    Thanks for reporting. Please describe the issue or suggestion below. 
                    Once saved, a CSV file will download.
                </p>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                    <textarea id="report-text" rows="4" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-500 outline-none" placeholder="Describe the bug or feature request..."></textarea>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="window.closeReportModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="window.saveReport()" class="px-4 py-2 text-sm font-bold text-white bg-red-600 rounded hover:bg-red-700 shadow-sm">Save & Download</button>
            </div>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100 m-4 border border-indigo-200 flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center flex-none">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-indigo-100 rounded-md text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">Project AI Assistant</h3>
                        <p class="text-xs text-slate-500">Powered by Gemini 2.0 Flash</p>
                    </div>
                </div>
                <button onclick="window.closeAIModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button onclick="window.aiAnalyzeRisks()" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all group">
                        <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">📉</span>
                        <span class="text-xs font-bold text-slate-700 uppercase">Analyze Risks</span>
                    </button>
                    <button onclick="window.aiDraftStatus()" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all group">
                        <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">📧</span>
                        <span class="text-xs font-bold text-slate-700 uppercase">Draft Status Email</span>
                    </button>
                    <div class="relative w-full">
                        <button onclick="window.aiBreakdownTask()" class="w-full h-full flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all group">
                            <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">🔨</span>
                            <span class="text-xs font-bold text-slate-700 uppercase">Break Down Task</span>
                        </button>
                        <select id="ai-task-selector" class="absolute bottom-1 left-2 right-2 text-[10px] border border-slate-200 rounded bg-white opacity-0 hover:opacity-100 focus:opacity-100 transition-opacity cursor-pointer">
                            <option value="">-- Select Task to Break Down --</option>
                        </select>
                    </div>
                </div>

                <!-- NEW: Progress Reporting Section -->
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <span class="text-lg">📅</span> Generate Action Report
                    </h4>
                    <div class="flex items-end gap-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">From Date</label>
                            <input type="date" id="ai-report-start" class="text-xs border border-slate-300 rounded px-2 py-1.5 focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">To Date</label>
                            <input type="date" id="ai-report-end" class="text-xs border border-slate-300 rounded px-2 py-1.5 focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                        </div>
                        <button onclick="window.aiGenerateActionReport()" class="flex-grow bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-1.5 px-3 rounded shadow-sm transition-colors h-[30px] flex items-center justify-center gap-2">
                            ✨ Generate Report
                        </button>
                    </div>
                </div>

                <!-- Result Area -->
                <div class="bg-slate-50 rounded-lg border border-slate-200 min-h-[150px] flex flex-col">
                    <div class="px-4 py-2 border-b border-slate-200 flex justify-between items-center bg-slate-100">
                        <span class="text-xs font-bold text-slate-500 uppercase">AI Response</span>
                        <div id="ai-loading" class="hidden flex items-center gap-2">
                            <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                    <div id="ai-output" class="p-4 text-sm text-slate-700 font-mono whitespace-pre-wrap leading-relaxed overflow-y-auto max-h-[300px]">Select an action above...</div>
                </div>
            </div>

            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-between items-center flex-none">
                <span class="text-[10px] text-slate-400 italic">AI responses may be inaccurate. Review before applying.</span>
                <button onclick="window.closeAIModal()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATASET ---
        const apiKey = ""; // API Key injected by environment
        let projectData = []; 
        let collapsedParents = new Set(); // To track collapsed rows
        let viewMode = 'week'; // Default view mode
        let currentTab = 'schedule';

        // SORT & FILTER STATE
        let raidState = {
            // FIXED: Default to gttMode: true (Show All)
            risks: { sortCol: 'id', sortDir: 'asc', filter: '', statusFilter: 'All', gttMode: true },
            issues: { sortCol: 'id', sortDir: 'asc', filter: '', statusFilter: 'All', gttMode: true },
            changes: { sortCol: 'id', sortDir: 'asc', filter: '', statusFilter: 'All', gttMode: true },
            comms: { sortCol: 'id', sortDir: 'asc', filter: '', statusFilter: 'All', gttMode: true },
            actions: { sortCol: 'id', sortDir: 'asc', filter: '', statusFilter: 'All', gttMode: true }
        };

        // RAID DATASETS (Sample PRINCE2 Data)
        let raidData = {
            risks: [
                { id: 1, category: "Supply Chain", details: "Hardware shipment delayed by customs", mitigation: "Use backup stock", notes: "Check tracking daily", raised: "2026-01-10", owner: "Logistics Mgr", level: "High", internal: false },
                { id: 2, category: "Resource", details: "Internal resourcing conflict for Project Mgr", mitigation: "Escalate to PMO", notes: "Pending approval", raised: "2026-01-15", owner: "Program Dir", level: "Medium", internal: true }
            ],
            // UPDATED: Issues matching new columns
            issues: [
                { 
                    id: 1, 
                    category: "Technical", 
                    owner: "Install Team", 
                    desc: "Incorrect cabling in Site 3", 
                    currentStatus: "Waiting for new cable order",
                    status: "Open", 
                    raised: "2026-03-28", 
                    target: "2026-04-05", 
                    updated: "2026-03-30", 
                    completed: "", 
                    internal: false 
                }
            ],
            // UPDATED: Changes matching new columns
            changes: [
                { 
                    id: 1, 
                    category: "Scope",
                    owner: "Project Mgr",
                    desc: "Add secondary 5G link to HQ", 
                    impact: "Cost: $5k, Time: +5 Days",
                    status: "Pending", 
                    raised: "2026-01-20",
                    target: "2026-02-15",
                    updated: "2026-01-22",
                    completed: "",
                    internal: false 
                }
            ],
            comms: [
                { id: 1, stake: "Project Board", info: "Status Report", freq: "Weekly", method: "Email/PDF", provider: "PM", internal: false },
                { id: 2, stake: "Internal Tech Team", info: "Technical Deep Dive", freq: "Daily", method: "Standup", provider: "Tech Lead", internal: true }
            ],
            // Updated sample action to include timestamps
            actions: [
                { 
                    id: 1, 
                    desc: "Prepare Steering Committee Slides", 
                    owner: "PM", 
                    due: "2026-02-15", 
                    status: "In Progress", 
                    internal: false,
                    created: "2026-02-01T09:00:00.000Z",
                    updated: "2026-02-10T10:00:00.000Z"
                }
            ]
        };

        // --- TEMPLATE DATA (Gantt) ---
        const templateData = [
            { id: 1, name: "Project Plan", type: "root", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 0 },
            { id: 2, name: "Project Milestones", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 3, name: "Pre-sales / Contract and PO signed", type: "Milestone", parent: 9, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 4, name: "Project Gate 1 - Kick off and Pilot Initiation", type: "Milestone", parent: 17, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 5, name: "Project Gate 2 - Onboarding and technical discovery", type: "Milestone", parent: 33, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 6, name: "Project Gate 3 - Pilot", type: "Milestone", parent: 45, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 7, name: "Project Gate 4 - Rollout", type: "Milestone", parent: 59, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            { id: 8, name: "Project Gate 5 - Service Handover and Closure", type: "Milestone", parent: 75, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 2 },
            
            { id: 9, name: "Pre-sales / Contract and PO signed", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 10, name: "Confirm final design with client", type: "Task", parent: 1, depType: "FS", dur: 3, start: "2026-01-09", pct: 100, indent: 2 },
            { id: 11, name: "Prepare SSD incl. cabling & design assumptions", type: "Task", parent: 10, depType: "FS", dur: 2, start: "2026-01-14", pct: 100, indent: 2 },
            { id: 12, name: "Enter orders into GTT system", type: "Task", parent: 10, depType: "FS", dur: 10, start: "2026-01-14", pct: 100, indent: 2 },
            { id: 13, name: "MSA signature", type: "Task", parent: 10, depType: "FS", dur: 12, start: "2026-01-14", pct: 0, indent: 2 },
            { id: 14, name: "PONs to be re-signed", type: "Task", parent: 12, depType: "FS", dur: 5, start: "2026-01-28", pct: 10, indent: 2 },
            { id: 15, name: "Orders validated by OA & SC", type: "Task", parent: 14, depType: "FS", dur: 2, start: "2026-02-04", pct: 10, indent: 2 },
            { id: 16, name: "EnvisionEdge Certification", type: "Task", parent: 1, depType: "FS", dur: 6, start: "2026-01-09", pct: 100, indent: 2 },
            
            { id: 17, name: "Project Gate 1 - Kick off and Pilot Initiation", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 18, name: "Internal Project Acceptance", type: "Task", parent: 15, depType: "FS", dur: 3, start: "2026-02-06", pct: 100, indent: 2 },
            { id: 19, name: "PON Data Validation - PM", type: "Task", parent: 18, depType: "FS", dur: 1, start: "2026-02-11", pct: 100, indent: 2 },
            { id: 20, name: "External Project Kick off", type: "Task", parent: 19, depType: "FS", dur: 2, start: "2026-02-12", pct: 100, indent: 2 },
            { id: 21, name: "Has the Project Initiation Document been agreed", type: "Task", parent: 20, depType: "FS", dur: 2, start: "2026-02-16", pct: 40, indent: 2 },
            { id: 22, name: "Has the Project Plan been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 23, name: "Has the Project Master Tracker been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 24, name: "Has the RAID Log been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 25, name: "Have the External Status Report been created", type: "Task", parent: 16, depType: "FS", dur: 2, start: "2026-01-19", pct: 100, indent: 2 },
            { id: 26, name: "Solution Consultant shared the SSD", type: "Task", parent: 16, depType: "FS", dur: 8, start: "2026-01-19", pct: 50, indent: 2 },
            { id: 27, name: "Solution Consultant shared the TAD", type: "Task", parent: 15, depType: "FS", dur: 2, start: "2026-02-06", pct: 90, indent: 2 },
            { id: 28, name: "Client to provide updated IP addresses", type: "Task", parent: 12, depType: "FS", dur: 1, start: "2026-01-28", pct: 90, indent: 2 },
            
            { id: 29, name: "Scope change", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 30, name: "Adding site 6B in CMD", type: "Task", parent: 29, depType: "FS", dur: 10, start: "2026-01-28", pct: 25, indent: 2 },
            { id: 31, name: "Receive the technical solution", type: "Task", parent: 30, depType: "FS", dur: 10, start: "2026-01-28", pct: 0, indent: 2 },
            { id: 32, name: "Complete pre-staging", type: "Task", parent: 31, depType: "FS", dur: 10, start: "2026-02-11", pct: 0, indent: 2 },
            
            { id: 33, name: "Project Gate 2 - Onboarding", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 34, name: "Scope/TAD been approved by TDA", type: "Task", parent: 27, depType: "FS", dur: 2, start: "2026-02-10", pct: 10, indent: 2 },
            { id: 35, name: "SD WAN Technical Workshop(s) Scheduled", type: "Task", parent: 27, depType: "FS", dur: 2, start: "2026-02-10", pct: 0, indent: 2 },
            { id: 36, name: "Review the configurations", type: "Task", parent: 27, depType: "FS", dur: 20, start: "2026-02-10", pct: 0, indent: 2 },
            { id: 37, name: "Provide feedback/Agree on the solution", type: "Task", parent: 36, depType: "FS", dur: 5, start: "2026-03-10", pct: 0, indent: 2 },
            { id: 38, name: "Has all client info been supplied?", type: "Task", parent: 28, depType: "FS", dur: 15, start: "2026-01-29", pct: 10, indent: 2 },
            
            { id: 39, name: "Logistics", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 40, name: "NetProv & SCM - confirm", type: "Task", parent: 15, depType: "FS", dur: 0, start: "2026-02-06", pct: 100, indent: 2 },
            { id: 41, name: "Pilot pre-staging completed", type: "Task", parent: 28, depType: "FS", dur: 6, start: "2026-01-29", pct: 75, indent: 2 },
            { id: 42, name: "HW for Pilot sites Shipment", type: "Task", parent: 41, depType: "FS", dur: 15, start: "2026-02-06", pct: 0, indent: 2 },
            { id: 43, name: "Remaining 11 sites pre-staging completed", type: "Task", parent: 27, depType: "FS", dur: 10, start: "2026-02-10", pct: 0, indent: 2 },
            { id: 44, name: "HW for 11+1.5 sites Shipment", type: "Task", parent: 43, depType: "FS", dur: 15, start: "2026-02-24", pct: 0, indent: 2 },
            
            { id: 45, name: "Project Gate 3 - Pilot", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 46, name: "Identify Pilot sites", type: "Task", parent: 21, depType: "FS", dur: 1, start: "2026-02-18", pct: 100, indent: 2 },
            { id: 47, name: "SD-WAN Technical Workshop (Final)", type: "Task", parent: 42, depType: "FS", dur: 3, start: "2026-02-27", pct: 0, indent: 2 },
            { id: 48, name: "Final Low Level Diagrams supplied", type: "Task", parent: 47, depType: "FS", dur: 1, start: "2026-03-04", pct: 0, indent: 2 },
            { id: 49, name: "Define Success vs Failure Scope", type: "Task", parent: 34, depType: "FS", dur: 5, start: "2026-02-18", pct: 0, indent: 2 },
            { id: 50, name: "Determine UAT", type: "Task", parent: 47, depType: "FS", dur: 1, start: "2026-03-04", pct: 0, indent: 2 },
            { id: 51, name: "Create a detailed runbook", type: "Task", parent: 47, depType: "FS", dur: 1, start: "2026-03-04", pct: 0, indent: 2 },
            
            { id: 52, name: "Migration onto SD WAN", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 53, name: "Site 1 DC Ecity", type: "Task", parent: 48, depType: "FS", dur: 5, start: "2026-03-05", pct: 0, indent: 2 },
            { id: 54, name: "Site 2 - Hyderabad", type: "Task", parent: 53, depType: "FS", dur: 2, start: "2026-03-12", pct: 0, indent: 2 },
            { id: 55, name: "Site 3 - Hennagara", type: "Task", parent: 54, depType: "FS", dur: 2, start: "2026-03-16", pct: 0, indent: 2 },
            { id: 56, name: "Design Agreed and signed", type: "Task", parent: 55, depType: "FS", dur: 5, start: "2026-03-18", pct: 0, indent: 2 },
            { id: 57, name: "Create the DDD", type: "Task", parent: 56, depType: "FS", dur: 1, start: "2026-03-25", pct: 0, indent: 2 },
            { id: 58, name: "Handover to Net Prov", type: "Task", parent: 57, depType: "FS", dur: 1, start: "2026-03-26", pct: 0, indent: 2 },
            
            { id: 59, name: "Project Gate 4 - Rollout", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 60, name: "Site 3", type: "Task", parent: 58, depType: "FS", dur: 5, start: "2026-03-27", pct: 0, indent: 2 },
            { id: 61, name: "Site 4", type: "Task", parent: 60, depType: "FS", dur: 2, start: "2026-04-03", pct: 0, indent: 2 },
            { id: 62, name: "Site 5", type: "Task", parent: 61, depType: "FS", dur: 2, start: "2026-04-07", pct: 0, indent: 2 },
            { id: 63, name: "Site 6", type: "Task", parent: 62, depType: "FS", dur: 2, start: "2026-04-09", pct: 0, indent: 2 },
            { id: 64, name: "Site 7", type: "Task", parent: 63, depType: "FS", dur: 2, start: "2026-04-13", pct: 0, indent: 2 },
            { id: 65, name: "Site 8", type: "Task", parent: 64, depType: "FS", dur: 2, start: "2026-04-15", pct: 0, indent: 2 },
            { id: 66, name: "Site 9", type: "Task", parent: 65, depType: "FS", dur: 2, start: "2026-04-17", pct: 0, indent: 2 },
            { id: 67, name: "Site 10", type: "Task", parent: 66, depType: "FS", dur: 2, start: "2026-04-21", pct: 0, indent: 2 },
            { id: 68, name: "Site 11", type: "Task", parent: 67, depType: "FS", dur: 2, start: "2026-04-23", pct: 0, indent: 2 },
            { id: 69, name: "Site 12", type: "Task", parent: 68, depType: "FS", dur: 2, start: "2026-04-27", pct: 0, indent: 2 },
            { id: 70, name: "Site 13", type: "Task", parent: 69, depType: "FS", dur: 2, start: "2026-04-29", pct: 0, indent: 2 },
            { id: 71, name: "Site 14", type: "Task", parent: 70, depType: "FS", dur: 2, start: "2026-05-01", pct: 0, indent: 2 },
            { id: 72, name: "Any issues with deployment", type: "Task", parent: 71, depType: "FS", dur: 10, start: "2026-05-05", pct: 0, indent: 2 },
            { id: 73, name: "EnvisionDX access granted", type: "Task", parent: 54, depType: "FS", dur: 1, start: "2026-03-16", pct: 0, indent: 2 },
            { id: 74, name: "Service Management / Account reviews", type: "Task", parent: 54, depType: "FS", dur: 1, start: "2026-03-16", pct: 0, indent: 2 },
            
            { id: 75, name: "Project Gate 5 - Service Handover and Closure", type: "Task", parent: null, depType: "FS", dur: 0, start: "2026-01-08", pct: 0, indent: 1 },
            { id: 76, name: "Lesssons Learned meeting", type: "Task", parent: 72, depType: "FS", dur: 3, start: "2026-05-19", pct: 0, indent: 2 },
            { id: 77, name: "Project Closed", type: "Milestone", parent: 76, depType: "FS", dur: 2, start: "2026-05-22", pct: 0, indent: 2 }
        ];

        // --- 2. LOGIC ---
        const criticalPathSet = new Set();
        let showBaseline = true;

        // NEW: Consolidated RAID Helper Functions (Defined before usage)
        
        window.updateStatusDropdown = function(type) {
            const select = document.getElementById(`status-filter-${type}`);
            if(!select || !raidData[type]) return;

            // Get unique statuses
            const uniqueStatuses = new Set();
            raidData[type].forEach(item => {
                if(item.status) uniqueStatuses.add(item.status);
            });

            // Save current selection
            const currentVal = select.value;

            // Rebuild Options
            let html = '<option value="All">All Status</option>';
            uniqueStatuses.forEach(s => {
                html += `<option value="${s}">${s}</option>`;
            });
            select.innerHTML = html;
            
            // Restore selection if valid
            if([...uniqueStatuses].includes(currentVal) || currentVal === 'All') {
                select.value = currentVal;
            }
        };

        window.sortRAID = function(type, column) {
            if (raidState[type].sortCol === column) {
                raidState[type].sortDir = raidState[type].sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                raidState[type].sortCol = column;
                raidState[type].sortDir = 'asc';
            }
            renderRAIDTable(type);
        };
        
        window.applyRAIDFilter = function(type) {
            const textEl = document.getElementById(`search-text-${type}`);
            const statusEl = document.getElementById(`status-filter-${type}`);
            
            if(textEl) raidState[type].filter = textEl.value;
            if(statusEl) raidState[type].statusFilter = statusEl.value;
            
            renderRAIDTable(type);
        };
        
        window.toggleGTTView = function(type) {
            raidState[type].gttMode = !raidState[type].gttMode;
            
            const btn = document.getElementById(`btn-gtt-view-${type}`);
            const isGTT = raidState[type].gttMode;

            // Visual toggle of the button style
            if(isGTT) {
                // Active (Show All): Solid color
                if(type === 'risks') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-amber-600 bg-amber-600 text-white shadow-sm transition-all";
                if(type === 'issues') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-red-600 bg-red-600 text-white shadow-sm transition-all";
                if(type === 'changes') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-blue-600 bg-blue-600 text-white shadow-sm transition-all";
                if(type === 'comms') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-indigo-600 bg-indigo-600 text-white shadow-sm transition-all";
                if(type === 'actions') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-emerald-600 bg-emerald-600 text-white shadow-sm transition-all";
            } else {
                // Inactive (Hide Internal/Client Mode): Outline style
                if(type === 'risks') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-amber-200 text-amber-700 hover:bg-amber-100 transition-all";
                if(type === 'issues') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-red-200 text-red-700 hover:bg-red-100 transition-all";
                if(type === 'changes') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-blue-200 text-blue-700 hover:bg-blue-100 transition-all";
                if(type === 'comms') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-indigo-200 text-indigo-700 hover:bg-indigo-100 transition-all";
                if(type === 'actions') btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-emerald-200 text-emerald-700 hover:bg-emerald-100 transition-all";
            }

            renderRAIDTable(type);
        };
        
        window.updateInternalStatus = function(type, id) {
             const item = raidData[type].find(i => i.id === id);
             if(item) {
                 item.internal = !item.internal;
                 // Re-render if we are currently hiding internals (GTT Mode OFF), to make it disappear immediately
                 if(!raidState[type].gttMode) renderRAIDTable(type);
                 else renderRAIDTable(type); // Re-render to update icon
             }
        };

        function initData() {
            projectData.forEach(t => {
                if (!t.baseStart) t.baseStart = t.start;
                if (!t.baseDur) t.baseDur = t.dur;
                if (!t.depType) t.depType = "FS"; 
                if (t.indent === undefined) t.indent = 0;
            });
            // Init dropdowns
            if (window.updateStatusDropdown) {
                ['risks', 'issues', 'changes', 'actions'].forEach(window.updateStatusDropdown);
            }
        }

        // --- GLOBAL: MODAL & TASK FUNCTIONS ---
        let editingId = null;
        let insertTargetId = null;

        window.openTaskModal = function(id = null, mode = 'edit') {
            try {
                const modal = document.getElementById('taskModal');
                const insertSelect = document.getElementById('m-insert');
                
                // Populate Insert Dropdown
                insertSelect.innerHTML = '<option value="end">-- End of List --</option>';
                if(projectData.length > 0) {
                    projectData.forEach((t, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        const safeName = (t.name || "Task").substring(0,30);
                        opt.text = `After: [${t.id}] ${safeName}...`;
                        insertSelect.appendChild(opt);
                    });
                }

                editingId = id;
                insertTargetId = null;

                if (mode === 'edit' && id) {
                    document.getElementById('modalTitle').innerText = "Edit Task";
                    document.getElementById('div-insert').classList.add('hidden');
                    const task = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = task.name;
                    document.getElementById('m-type').value = task.type;
                    document.getElementById('m-parent').value = task.parent || '';
                    document.getElementById('m-depType').value = task.depType || 'FS';
                    document.getElementById('m-start').value = task.start;
                    document.getElementById('m-dur').value = task.dur;
                    document.getElementById('m-pct').value = task.pct;
                    document.getElementById('m-indent').value = task.indent || 0;
                } else if (mode === 'subtask' && id) {
                    insertTargetId = id;
                    document.getElementById('modalTitle').innerText = "Add Subtask";
                    document.getElementById('div-insert').classList.add('hidden');
                    const parentTask = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = ""; 
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                    document.getElementById('m-indent').value = (parentTask.indent || 0) + 1;
                    editingId = null;
                } else if (mode === 'insert' && id) {
                    insertTargetId = id;
                    document.getElementById('modalTitle').innerText = "Insert Task Below";
                    document.getElementById('div-insert').classList.add('hidden');
                    const siblingTask = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = id; 
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                    document.getElementById('m-indent').value = siblingTask.indent || 0;
                    editingId = null;
                } else {
                    // Default Add New Task
                    document.getElementById('modalTitle').innerText = "Add New Task";
                    document.getElementById('div-insert').classList.remove('hidden');
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = "";
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                    document.getElementById('m-indent').value = "0";
                }
                toggleDurationState();
                modal.classList.remove('hidden');
            } catch (err) { console.error(err); alert("Error opening modal: " + err.message); }
        };

        window.closeModal = function() { 
            document.getElementById('taskModal').classList.add('hidden'); 
        };

        window.saveTask = function() {
            try {
                const name = document.getElementById('m-name').value || "New Task";
                const type = document.getElementById('m-type').value;
                let dur = parseInt(document.getElementById('m-dur').value) || 0;
                if (type === 'Milestone') dur = 0; 
                
                const start = document.getElementById('m-start').value || new Date().toISOString().split('T')[0];
                const pct = parseInt(document.getElementById('m-pct').value) || 0;
                const parentInput = document.getElementById('m-parent').value;
                const parent = parentInput ? parseInt(parentInput) : null;
                const depType = document.getElementById('m-depType').value;
                const indent = parseInt(document.getElementById('m-indent').value) || 0;

                if (editingId) {
                    const task = projectData.find(t => t.id === editingId);
                    if (task) Object.assign(task, { name, type, dur, start, pct, parent, depType, indent });
                } else {
                    const maxId = projectData.length > 0 ? Math.max(...projectData.map(t => t.id)) : 0;
                    const newId = maxId + 1;
                    
                    const newTask = { id: newId, name, type, dur, start, pct, parent, depType, baseStart: start, baseDur: dur, indent };
                    
                    if (insertTargetId) {
                        const idx = projectData.findIndex(t => t.id === insertTargetId);
                        if (idx !== -1) {
                            projectData.splice(idx + 1, 0, newTask);
                        } else {
                            projectData.push(newTask);
                        }
                    } else {
                        const insertVal = document.getElementById('m-insert').value;
                        if (insertVal === "end") projectData.push(newTask);
                        else projectData.splice(parseInt(insertVal) + 1, 0, newTask);
                    }
                }
                refreshView();
                closeModal();
            } catch(err) { console.error(err); alert("Error saving task"); }
        };

        window.deleteTask = function(id) {
            window.openConfirmModal(`Delete Task ID: ${id}?`, () => {
                const idx = projectData.findIndex(t => t.id === id);
                if (idx > -1) { 
                    projectData.forEach(t => { if(t.parent === id) t.parent = null; });
                    projectData.splice(idx, 1); 
                    refreshView(); 
                }
            });
        };

        // --- NEW: Custom Delete Modal Logic ---
        let pendingDeleteCallback = null;

        window.openConfirmModal = function(msg, callback) {
            document.querySelector('#deleteConfirmModal h3').innerText = "Confirm Delete";
            document.querySelector('#deleteConfirmModal p').innerText = msg;
            pendingDeleteCallback = callback;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        };

        window.closeDeleteModal = function() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            pendingDeleteCallback = null;
        };

        // Attach listener to the generic confirm button in modal
        document.getElementById('confirmDeleteBtn').onclick = function() {
            if (pendingDeleteCallback) pendingDeleteCallback();
            window.closeDeleteModal();
        };
        
        // --- REPORTING ---
        window.openReportModal = function() {
            document.getElementById('report-text').value = "";
            document.getElementById('reportModal').classList.remove('hidden');
        };

        window.closeReportModal = function() {
            document.getElementById('reportModal').classList.add('hidden');
        };

        window.saveReport = function() {
            const text = document.getElementById('report-text').value;
            if(!text.trim()) { alert("Please enter a description."); return; }
            
            const timestamp = new Date().toISOString();
            const headers = ["Timestamp", "Type", "Description"];
            const row = [timestamp, "User Report/Request", `"${text.replace(/"/g, '""')}"`];
            const csvContent = [headers.join(","), row.join(",")].join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const filename = `report_dorin_${new Date().toISOString().slice(0,10)}.csv`;
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.closeReportModal();
            alert("Report downloaded! Please send to Dorin.");
        };

        // --- TABS LOGIC ---
        function switchTab(tabId) {
            currentTab = tabId;
            // Update Tab Styles
            ['schedule', 'risks', 'issues', 'changes', 'comms', 'actions'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tabId) {
                    btn.classList.remove('border-transparent', 'text-slate-500');
                    btn.classList.add('border-indigo-600', 'text-indigo-600');
                } else {
                    btn.classList.add('border-transparent', 'text-slate-500');
                    btn.classList.remove('border-indigo-600', 'text-indigo-600');
                }
                
                // Hide/Show Content Views
                const view = document.getElementById(`view-${t}`);
                if(view) {
                    if (t === tabId) view.classList.remove('hidden'); 
                    else view.classList.add('hidden');
                }
            });

            // Toggle Header Controls
            const schedControls = document.getElementById('controls-schedule');
            const raidControls = document.getElementById('controls-raid');
            
            if (tabId === 'schedule') {
                schedControls.classList.remove('hidden');
                raidControls.classList.add('hidden');
                refreshView();
            } else {
                schedControls.classList.add('hidden');
                raidControls.classList.remove('hidden');
                renderRAIDTable(tabId);
            }
        }

        // --- RESIZING LOGIC ---
        function enableColumnResizing() {
            const headers = document.querySelectorAll('th');
            // We don't necessarily need to select table here if we rely on computed styles,
            // but ensuring the table isn't display: flex is key (handled in CSS).

            headers.forEach(th => {
                // Create resizer handle
                const resizer = document.createElement('div');
                resizer.classList.add('resizer');
                th.appendChild(resizer);

                // Drag logic variables
                let startX = 0;
                let startWidth = 0;

                const mouseDownHandler = (e) => {
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    
                    // Stop event bubbling so it doesn't trigger sort/other actions
                    e.stopPropagation();

                    // Add listeners to document so dragging works even if mouse leaves the handle
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    resizer.classList.add('resizing');
                };

                const mouseMoveHandler = (e) => {
                    const dx = e.pageX - startX;
                    const newWidth = Math.max(30, startWidth + dx); // Minimum width 30px
                    th.style.width = `${newWidth}px`;
                };

                const mouseUpHandler = () => {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    resizer.classList.remove('resizing');
                };

                resizer.addEventListener('mousedown', mouseDownHandler);
            });
        }

        // NEW: Panel Resizing Logic
        function enablePanelResizing() {
            const resizer = document.getElementById('panel-resizer');
            const leftPanel = document.getElementById('left-panel');
            const mainContainer = document.getElementById('view-schedule'); // Fix: Resize within schedule view
            let isResizing = false;

            if(!resizer || !leftPanel || !mainContainer) return;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                resizer.classList.add('bg-indigo-600'); // Active state visual
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                // Calculate new width percentage based on mouse position relative to container
                const containerWidth = mainContainer.offsetWidth;
                const newWidthPct = (e.clientX / containerWidth) * 100;
                
                // Set limits (e.g., maintain at least 10% and leave at least 10% for chart)
                if(newWidthPct > 10 && newWidthPct < 90) {
                    leftPanel.style.width = `${newWidthPct}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                    resizer.classList.remove('bg-indigo-600');
                }
            });
        }

        function setViewMode(mode) {
            viewMode = mode;
            renderChart();
        }

        function loadTemplate() {
            if(projectData.length > 0 && !confirm("Load Standard SD-WAN Template? This will overwrite current data.")) return;
            
            projectData = JSON.parse(JSON.stringify(templateData));
            calculateSchedule(); 
            projectData.forEach(t => {
                t.baseStart = t.start;
                t.baseDur = t.dur;
            });
            refreshView();
        }
        
        function calculateCriticalPath() {
            criticalPathSet.clear();
            if (projectData.length === 0) return;
            
            let lastTask = projectData[0];
            let maxEnd = 0;
            projectData.forEach(t => {
                const end = new Date(t.start).getTime() + (t.dur * 86400000);
                if (end > maxEnd) { maxEnd = end; lastTask = t; }
            });

            if(!lastTask) return;

            const trace = (taskId) => {
                criticalPathSet.add(taskId);
                const t = projectData.find(x => x.id === taskId);
                if (t && t.parent) trace(t.parent);
            };
            trace(lastTask.id);
        }

        function calculateSchedule() {
            const taskMap = new Map(projectData.map(t => [t.id, t]));
            const cache = new Map();
            const stack = []; 

            function resolveStart(taskId) {
                if(cache.has(taskId)) return cache.get(taskId);
                
                const task = taskMap.get(taskId);
                if(!task) return new Date(); 
                
                if(stack.includes(taskId)) {
                    console.warn("Circular dependency detected:", taskId);
                    return new Date(task.start);
                }
                stack.push(taskId);

                if(!task.parent || !taskMap.has(task.parent)) {
                    const d = new Date(task.start);
                    cache.set(taskId, d);
                    stack.pop();
                    return d;
                }

                const pStart = resolveStart(task.parent);
                const parent = taskMap.get(task.parent);
                
                const pDur = parent.dur || 0;
                const pEnd = new Date(pStart.getTime() + (pDur * 86400000));
                
                let newStart;
                switch(task.depType) {
                    case 'SS': newStart = pStart; break;
                    case 'FF': newStart = new Date(pEnd.getTime() - (task.dur * 86400000)); break;
                    case 'SF': newStart = new Date(pStart.getTime() - (task.dur * 86400000)); break;
                    case 'FS': default: newStart = pEnd; break;
                }
                
                if (isNaN(newStart.getTime())) newStart = pEnd;
                
                cache.set(taskId, newStart);
                stack.pop();
                return newStart;
            }

            projectData.forEach(task => {
                const s = resolveStart(task.id);
                task.start = s.toISOString().split('T')[0];
            });
        }

        function setBaseline() {
            if(confirm("Overwrite Baseline?")) {
                projectData.forEach(t => { t.baseStart = t.start; t.baseDur = t.dur; });
                renderChart();
            }
        }

        function toggleBaseline() {
            showBaseline = document.getElementById('showBaselineToggle').checked;
            renderChart();
        }

        function toggleDurationState() {
            const type = document.getElementById('m-type').value;
            const durInput = document.getElementById('m-dur');
            if (type === 'Milestone') {
                durInput.value = 0;
                durInput.disabled = true;
                durInput.classList.add('bg-slate-100', 'text-slate-400');
            } else {
                durInput.disabled = false;
                durInput.classList.remove('bg-slate-100', 'text-slate-400');
            }
        }

        function modifyIndent(id, change) {
            const task = projectData.find(t => t.id === id);
            if(task) {
                task.indent = Math.max(0, (task.indent || 0) + change);
                renderTable();
            }
        }

        function toggleCollapse(id) {
            if(collapsedParents.has(id)) collapsedParents.delete(id);
            else collapsedParents.add(id);
            renderTable();
            renderChart();
        }

        function isRowVisible(index) {
            if (index === 0) return true;
            let currentIndent = projectData[index].indent;
            for(let i = index - 1; i >= 0; i--) {
                const t = projectData[i];
                if(t.indent < currentIndent) {
                    if(collapsedParents.has(t.id)) return false;
                    currentIndent = t.indent;
                }
                if(currentIndent === 0) break;
            }
            return true;
        }

        // --- NEW: Toggle Task Action ---
        window.toggleTaskAction = function(taskId, isChecked) {
            const task = projectData.find(t => t.id === taskId);
            if (!task) return;

            if (isChecked) {
                // Create Action
                const endDate = new Date(new Date(task.start).getTime() + (task.dur * 86400000)).toISOString().split('T')[0];
                const now = new Date().toISOString();
                const newAction = {
                    id: Date.now(),
                    desc: task.name,
                    owner: "PM", // Default
                    due: endDate,
                    status: "Pending",
                    internal: false, // Default to public
                    linkedTaskId: taskId,
                    created: now,
                    updated: now
                };
                task.linkedActionId = newAction.id;
                if (!raidData.actions) raidData.actions = [];
                raidData.actions.push(newAction);
            } else {
                // Remove Action
                if (task.linkedActionId && raidData.actions) {
                    raidData.actions = raidData.actions.filter(a => a.id !== task.linkedActionId);
                    task.linkedActionId = null;
                }
            }
            if(window.updateStatusDropdown) window.updateStatusDropdown('actions');
        };

        // --- IMPORT/EXPORT (Excel .xlsx with Tabs) ---
        
        function exportProjectExcel() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();

            // 1. SCHEDULE SHEET
            const scheduleData = projectData.map(t => ({
                "ID": t.id,
                "Name": t.name,
                "Type": t.type,
                "Parent": t.parent,
                "Dependency Type": t.depType,
                "Duration": t.dur,
                "Start": t.start,
                "% Complete": t.pct,
                "Indent Level": t.indent,
                "Linked Action ID": t.linkedActionId,
                "Baseline Start": t.baseStart,
                "Baseline Duration": t.baseDur
            }));
            const wsSchedule = XLSX.utils.json_to_sheet(scheduleData);
            XLSX.utils.book_append_sheet(wb, wsSchedule, "Schedule");

            // 2. RISKS SHEET
            if(raidData.risks && raidData.risks.length > 0) {
                const risksData = raidData.risks.map(i => ({
                    "ID": i.id, "Description": i.desc, "Probability": i.prob, "Impact": i.impact,
                    "Response": i.response, "Owner": i.owner, "Status": i.status, "Internal": i.internal
                }));
                const wsRisks = XLSX.utils.json_to_sheet(risksData);
                XLSX.utils.book_append_sheet(wb, wsRisks, "Risks");
            }

            // 3. ISSUES SHEET
            if(raidData.issues && raidData.issues.length > 0) {
                const issuesData = raidData.issues.map(i => ({
                    "ID": i.id, "Description": i.desc, "Priority": i.priority, "Severity": i.sev,
                    "Owner": i.owner, "Date Raised": i.raised, "Status": i.status, "Internal": i.internal
                }));
                const wsIssues = XLSX.utils.json_to_sheet(issuesData);
                XLSX.utils.book_append_sheet(wb, wsIssues, "Issues");
            }

            // 4. CHANGES SHEET
            if(raidData.changes && raidData.changes.length > 0) {
                const changesData = raidData.changes.map(i => ({
                    "ID": i.id, "Description": i.desc, "Raised By": i.raisedBy, "Cost": i.cost,
                    "Time Impact": i.time, "Status": i.status, "Internal": i.internal
                }));
                const wsChanges = XLSX.utils.json_to_sheet(changesData);
                XLSX.utils.book_append_sheet(wb, wsChanges, "Changes");
            }

            // 5. COMMS SHEET
            if(raidData.comms && raidData.comms.length > 0) {
                const commsData = raidData.comms.map(i => ({
                    "ID": i.id, "Stakeholder": i.stake, "Info Required": i.info, "Frequency": i.freq,
                    "Method": i.method, "Provider": i.provider, "Internal": i.internal
                }));
                const wsComms = XLSX.utils.json_to_sheet(commsData);
                XLSX.utils.book_append_sheet(wb, wsComms, "Comms");
            }

            // 6. ACTIONS SHEET
            if(raidData.actions && raidData.actions.length > 0) {
                const actionsData = raidData.actions.map(i => ({
                    "ID": i.id, "Description": i.desc, "Owner": i.owner, "Due Date": i.due,
                    "Status": i.status, "Internal": i.internal, "Linked Task ID": i.linkedTaskId,
                    "Created At": i.created, "Updated At": i.updated
                }));
                const wsActions = XLSX.utils.json_to_sheet(actionsData);
                XLSX.utils.book_append_sheet(wb, wsActions, "Actions");
            }

            // Write File
            XLSX.writeFile(wb, `sdwan_project_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function importProjectExcel(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});

                    // 1. IMPORT SCHEDULE
                    if(wb.Sheets["Schedule"]) {
                        const rawSchedule = XLSX.utils.sheet_to_json(wb.Sheets["Schedule"]);
                        projectData = rawSchedule.map(row => ({
                            id: row["ID"],
                            name: row["Name"],
                            type: row["Type"],
                            parent: row["Parent"] || null,
                            depType: row["Dependency Type"],
                            dur: row["Duration"],
                            start: row["Start"],
                            pct: row["% Complete"],
                            indent: row["Indent Level"] || 0,
                            linkedActionId: row["Linked Action ID"] || null,
                            baseStart: row["Baseline Start"],
                            baseDur: row["Baseline Duration"]
                        }));
                    }

                    // 2. IMPORT RAID DATA (Helper)
                    const importSheet = (sheetName, mapFn) => {
                        if(wb.Sheets[sheetName]) {
                            const raw = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                            return raw.map(mapFn);
                        }
                        return [];
                    };

                    raidData.risks = importSheet("Risks", r => ({
                        id: r["Number"] || r["ID"], category: r["Category"], details: r["Risk Details"], mitigation: r["Mitigating Action"],
                        notes: r["Notes"], raised: r["Raised"], owner: r["Owner"], level: r["Level"], internal: r["Internal"]
                    }));

                    raidData.issues = importSheet("Issues", r => ({
                        id: r["Number"] || r["ID"], category: r["Category"], owner: r["Issue Assigned to"] || r["Owner"], desc: r["Description"],
                        currentStatus: r["Current Status"], status: r["Status"], raised: r["Raised"], target: r["Target"],
                        updated: r["Updated"], completed: r["Completed"], internal: r["Internal"]
                    }));

                    // UPDATED: Import Changes Columns (handling potential name mapping)
                    raidData.changes = importSheet("Change Control", r => ({
                        id: r["Number"] || r["ID"], 
                        category: r["Category"], 
                        owner: r["Assigned to"] || r["Owner"], 
                        desc: r["Description"], 
                        impact: r["Impact / Status"] || r["Impact"],
                        status: r["Status"], 
                        raised: r["Raised"], 
                        target: r["Target"], 
                        updated: r["Updated"], 
                        completed: r["Complete"] || r["Completed"],
                        internal: r["Internal"]
                    }));
                    // Fallback to "Changes" sheet name if "Change Control" not found (backward compatibility)
                    if(raidData.changes.length === 0) {
                         raidData.changes = importSheet("Changes", r => ({
                            id: r["ID"], desc: r["Description"], raisedBy: r["Raised By"], cost: r["Cost"],
                            time: r["Time Impact"], status: r["Status"], internal: r["Internal"]
                        }));
                    }

                    raidData.comms = importSheet("Comms", r => ({
                        id: r["ID"], stake: r["Stakeholder"], info: r["Info Required"], freq: r["Frequency"],
                        method: r["Method"], provider: r["Provider"], internal: r["Internal"]
                    }));

                    raidData.actions = importSheet("Actions", r => ({
                        id: r["ID"], desc: r["Description"], owner: r["Owner"], due: r["Due Date"],
                        status: r["Status"], internal: r["Internal"], linkedTaskId: r["Linked Task ID"] || null,
                        created: r["Created At"] || new Date().toISOString(), updated: r["Updated At"] || new Date().toISOString()
                    }));

                    // Refresh App
                    calculateSchedule();
                    refreshView();
                    if(currentTab !== 'schedule') { 
                        renderRAIDTable(currentTab); 
                        if(window.updateStatusDropdown) window.updateStatusDropdown(currentTab); 
                    }
                    
                    alert("Project successfully imported from Excel!");
                } catch (err) {
                    console.error(err);
                    alert("Error importing Excel file. Please ensure the format is correct.");
                }
            };
            reader.readAsArrayBuffer(file);
            input.value = ""; // Reset input
        }

        // --- AI REPORTING LOGIC ---
        function openAIModal() {
            // Populate task selector
            const select = document.getElementById('ai-task-selector');
            select.innerHTML = '<option value="">-- Select Parent Task --</option>';
            projectData.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.text = `[${t.id}] ${t.name.substring(0,40)}`;
                select.appendChild(opt);
            });
            
            // Set default date range for report (last 7 days to today)
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 7);
            
            document.getElementById('ai-report-start').value = start.toISOString().split('T')[0];
            document.getElementById('ai-report-end').value = end.toISOString().split('T')[0];
            
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('ai-output').textContent = "Ready to assist. Select an action above.";
        }

        async function aiGenerateActionReport() {
            const startVal = document.getElementById('ai-report-start').value;
            const endVal = document.getElementById('ai-report-end').value;
            
            if(!startVal || !endVal) {
                document.getElementById('ai-output').textContent = "Please select both a Start and End date for the report.";
                return;
            }

            const startDate = new Date(startVal);
            const endDate = new Date(endVal);
            // Adjust end date to end of day to include items from that day
            endDate.setHours(23, 59, 59, 999);

            // Filter Actions based on timestamps
            const reportActions = raidData.actions.filter(a => {
                const created = new Date(a.created);
                const updated = new Date(a.updated);
                
                // Include if created OR updated in the range
                const inRange = (created >= startDate && created <= endDate) || 
                                (updated >= startDate && updated <= endDate);
                return inRange;
            });

            if(reportActions.length === 0) {
                document.getElementById('ai-output').textContent = `No actions found created or updated between ${startVal} and ${endVal}.`;
                return;
            }

            // Simplify data for AI token limit
            const summaryData = reportActions.map(a => ({
                desc: a.desc,
                owner: a.owner,
                status: a.status,
                due: a.due,
                updated: a.updated.split('T')[0]
            }));

            const prompt = `Act as a Project Manager. Generate a professional status report for the following project actions (JSON below) that were active between ${startVal} and ${endVal}.
            
            Key Requirements:
            1. Summarize "Completed" vs "Pending" actions.
            2. Highlight any items that are overdue relative to today's date.
            3. Group by Owner if applicable.
            4. Keep the tone concise and business-like (bullet points).
            
            Data: ${JSON.stringify(summaryData)}`;

            const result = await callGemini(prompt);
            if(result) document.getElementById('ai-output').textContent = result;
        }

        // --- AI ACTIONS (EXISTING) ---
        async function aiAnalyzeRisks() {
            // Create a lightweight summary of the project to save tokens
            const summary = projectData.map(t => ({
                id: t.id, name: t.name, dur: t.dur, 
                pct: t.pct, dep: t.parent
            }));
            
            const prompt = `Act as a Senior Project Manager. Analyze this SD-WAN project schedule (JSON below) for risks. 
            Focus on: 
            1. Unrealistic durations (too short/long).
            2. Bottlenecks (tasks with many dependencies).
            3. Tasks with 0% progress that should have started.
            
            Keep the response concise, bulleted, and professional.
            
            Data: ${JSON.stringify(summary)}`;

            const result = await callGemini(prompt);
            if(result) document.getElementById('ai-output').textContent = result;
        }

        async function aiDraftStatus() {
            const completed = projectData.filter(t => t.pct === 100).length;
            const total = projectData.length;
            const percent = Math.round((completed/total)*100);
            
            const prompt = `Draft a professional email to stakeholders about this SD-WAN project.
            
            Stats: ${percent}% complete. ${completed}/${total} tasks done.
            Project Start: ${projectData[0]?.start || 'N/A'}.
            
            Structure:
            1. Executive Summary
            2. Key Achievements (invent 2-3 generic ones based on SD-WAN context)
            3. Next Steps
            4. Risks/Blockers (mention "None currently reported" if unknown)
            
            Tone: Professional, concise.`;

            const result = await callGemini(prompt);
            if(result) document.getElementById('ai-output').textContent = result;
        }

        async function aiBreakdownTask() {
            const select = document.getElementById('ai-task-selector');
            const parentId = parseInt(select.value);
            
            if(!parentId) {
                document.getElementById('ai-output').textContent = "Please select a task from the dropdown inside the 'Break Down Task' button area first.";
                return;
            }

            const parentTask = projectData.find(t => t.id === parentId);
            if(!parentTask) return;

            const prompt = `I have a task named "${parentTask.name}" in an SD-WAN project.
            Break this down into 3-5 logical subtasks.
            
            IMPORTANT: Return ONLY a valid JSON array. Do not include markdown formatting (like \`\`\`json).
            Format: [{"name": "Subtask Name", "dur": 3}, {"name": "Another Subtask", "dur": 2}]`;

            const result = await callGemini(prompt);
            
            if(result) {
                try {
                    // Clean text just in case AI adds markdown
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const subtasks = JSON.parse(cleanJson);
                    
                    let msg = `Generated ${subtasks.length} subtasks for "${parentTask.name}":\n`;
                    
                    // Add to project data
                    const parentIdx = projectData.findIndex(t => t.id === parentId);
                    const newIndent = (parentTask.indent || 0) + 1;
                    const maxId = Math.max(...projectData.map(t => t.id));
                    let currentId = maxId + 1;
                    
                    // Reverse loop to insert right after parent without messing up order
                    for(let i = subtasks.length - 1; i >= 0; i--) {
                        const st = subtasks[i];
                        const newTask = {
                            id: currentId++,
                            name: "✨ " + st.name, // Mark as AI generated
                            type: 'Task',
                            parent: parentId,
                            depType: 'FS',
                            dur: st.dur || 1,
                            start: parentTask.start, // Logic will fix date later
                            pct: 0,
                            baseStart: parentTask.start,
                            baseDur: st.dur || 1,
                            indent: newIndent
                        };
                        projectData.splice(parentIdx + 1, 0, newTask);
                        msg += `- [Added] ${st.name} (${st.dur} days)\n`;
                    }
                    
                    refreshView();
                    document.getElementById('ai-output').textContent = msg + "\n\nSchedule updated automatically!";
                    
                } catch(e) {
                    document.getElementById('ai-output').textContent = "Failed to parse AI response. Raw output:\n" + result;
                }
            }
        }

        // --- RAID CRUD & RENDER ---
        window.addRAIDItem = function() {
            const table = currentTab;
            if(!raidData[table]) return;
            
            const arr = raidData[table];
            const now = new Date().toISOString();
            const newItem = { id: Date.now(), internal: false }; // Default internal to false
            
            // Default Values based on Type
            // UPDATED: Default values for new Risk schema
            if(table === 'risks') { Object.assign(newItem, { category: "General", details: "New Risk", mitigation: "Plan B", notes: "", raised: new Date().toISOString().split('T')[0], owner: "PM", level: "Low" }); }
            else if(table === 'issues') { Object.assign(newItem, { desc: "New Issue", priority: "Med", sev: "Med", owner: "PM", raised: new Date().toISOString().split('T')[0], status: "Open" }); }
            else if(table === 'changes') { Object.assign(newItem, { desc: "Change Request", raisedBy: "Stakeholder", cost: "$0", time: "0 Days", status: "Pending" }); }
            else if(table === 'comms') { Object.assign(newItem, { stake: "Stakeholder", info: "Update", freq: "Weekly", method: "Email", provider: "PM" }); }
            else if(table === 'actions') { Object.assign(newItem, { desc: "New Action", owner: "Unassigned", due: new Date().toISOString().split('T')[0], status: "Pending", created: now, updated: now }); }
            
            arr.push(newItem);
            renderRAIDTable(table);
            updateStatusDropdown(table); // Refresh dropdown on add
        };

        window.makeEditableRAID = function(cell, id, field, table) {
            if (cell.querySelector('input, select')) return;
            
            const item = raidData[table].find(i => i.id === id);
            if(!item) return;
            
            const oldVal = item[field];
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldVal || '';
            input.className = 'w-full h-full p-1 text-xs border border-indigo-500 rounded bg-indigo-50 outline-none';
            
            // FIXED: LOCAL DOM UPDATE ONLY (Prevents destroying Delete button)
            input.onblur = () => {
                const newVal = input.value;
                if(item[field] !== newVal) {
                    item[field] = newVal;
                    cell.innerHTML = newVal; 
                    
                    // Refresh status dropdown if status changed (or Category for Risks)
                    if(field === 'status' || field === 'category') updateStatusDropdown(table);

                    // Update timestamp for Actions
                    if(table === 'actions') item.updated = new Date().toISOString();

                    // NEW LOGIC FOR SYNC (Actions -> Schedule)
                    if (table === 'actions' && field === 'status' && (newVal.toLowerCase() === 'done' || newVal.toLowerCase() === 'complete')) {
                        if (item.linkedTaskId) {
                            const task = projectData.find(t => t.id === item.linkedTaskId);
                            if (task) {
                                task.pct = 100;
                            }
                        }
                    }
                    // Re-render table if showing actions to update timestamp column UI (optional, but good for feedback)
                    if(table === 'actions') setTimeout(() => renderRAIDTable(table), 50); 
                } else {
                    cell.innerHTML = newVal; // Restore if no change
                }
            };
            input.onkeydown = (e) => {
                if(e.key === 'Enter') input.blur();
            };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        };

        function renderRAIDTable(type) {
            const tbody = document.getElementById(`tbody-${type}`);
            if(!tbody || !raidData[type]) return;
            
            // Filter
            let data = raidData[type].filter(item => {
                // GTT Mode Check: If GTT Mode is OFF (false), HIDE internal items
                if (!raidState[type].gttMode && item.internal) return false;

                const term = raidState[type].filter.toLowerCase();
                const statusFilter = raidState[type].statusFilter;
                
                // Status Filter Check (Handle Risk Category separately)
                if (statusFilter !== 'All') {
                    if (type === 'risks' && item.category !== statusFilter) return false;
                    if (type !== 'risks' && item.status !== statusFilter) return false;
                }

                // Text Search Check
                if (!term) return true;
                return Object.values(item).some(val => String(val).toLowerCase().includes(term));
            });

            // Sort
            const { sortCol, sortDir } = raidState[type];
            data.sort((a, b) => {
                let valA = a[sortCol];
                let valB = b[sortCol];
                
                if (typeof valA === 'number' && typeof valB === 'number') {
                     return sortDir === 'asc' ? valA - valB : valB - valA;
                }
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                if(valA < valB) return sortDir === 'asc' ? -1 : 1;
                if(valA > valB) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update Header Icons
            document.querySelectorAll(`.sort-icon-${type}`).forEach(el => el.innerHTML = '⇅');
            const activeIcon = document.getElementById(`sort-icon-${type}-${sortCol}`);
            if(activeIcon) activeIcon.innerHTML = sortDir === 'asc' ? '↑' : '↓';

            tbody.innerHTML = '';
            data.forEach(item => {
                // Visual cue for Internal Rows
                const rowClass = item.internal 
                    ? 'raid-row bg-slate-50 border-b border-slate-200 border-l-4 border-l-slate-400 text-slate-500' // Internal Style
                    : 'raid-row hover:bg-slate-50 border-b border-slate-100 border-l-4 border-l-transparent transition-colors'; // Normal Style

                const tr = document.createElement('tr');
                tr.className = rowClass;
                
                let cells = '';
                const displayId = item.id > 9999 ? 'New' : item.id;
                
                cells += `<td class="p-3 text-center text-xs font-mono font-bold ${item.internal ? 'text-slate-400' : 'text-slate-600'}">${displayId}</td>`;
                
                // NEW: Icon Toggle for Internal
                const eyeIcon = item.internal 
                    // Slashed Eye (Internal)
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-rose-500 hover:text-rose-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`
                    // Open Eye (Public)
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto text-slate-300 hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;

                cells += `<td class="p-3 text-center cursor-pointer" onclick="window.updateInternalStatus('${type}', ${item.id})" title="${item.internal ? 'Internal (Hidden in Client Mode)' : 'Public (Visible)'}">${eyeIcon}</td>`;

                // Specific Cells (Calls window.makeEditableRAID)
                // UPDATED: Risk Cells to match new columns
                if(type === 'risks') {
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'category', 'risks')">${item.category}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-700 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'details', 'risks')">${item.details}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'mitigation', 'risks')">${item.mitigation}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'notes', 'risks')">${item.notes}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'raised', 'risks')">${item.raised}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'owner', 'risks')">${item.owner}</td>`;
                    cells += `<td class="p-3 text-xs font-bold ${item.level==='High'?'text-rose-600':(item.level==='Medium'?'text-amber-600':'text-emerald-600')} cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'level', 'risks')">${item.level}</td>`;
                } else if(type === 'issues') {
                    // UPDATED: Issue Cells matching new columns
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'category', 'issues')">${item.category}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'owner', 'issues')">${item.owner}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-700 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'desc', 'issues')">${item.desc}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'currentStatus', 'issues')">${item.currentStatus}</td>`;
                    cells += `<td class="p-3 text-xs font-bold ${item.status==='Open'?'text-rose-600':'text-emerald-600'} cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'status', 'issues')">${item.status}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'raised', 'issues')">${item.raised}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'target', 'issues')">${item.target}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'updated', 'issues')">${item.updated}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'completed', 'issues')">${item.completed}</td>`;
                } else if(type === 'changes') {
                    cells += `<td class="p-3 text-xs text-slate-700 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'desc', 'changes')">${item.desc}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'raisedBy', 'changes')">${item.raisedBy}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'cost', 'changes')">${item.cost}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'time', 'changes')">${item.time}</td>`;
                    cells += `<td class="p-3 text-xs font-bold ${item.status==='Pending'?'text-amber-500':(item.status==='Approved'?'text-emerald-600':'text-rose-600')} cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'status', 'changes')">${item.status}</td>`;
                } else if(type === 'comms') {
                    cells += `<td class="p-3 text-xs text-slate-700 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'stake', 'comms')">${item.stake}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'info', 'comms')">${item.info}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'freq', 'comms')">${item.freq}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'method', 'comms')">${item.method}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'provider', 'comms')">${item.provider}</td>`;
                } else if(type === 'actions') {
                    cells += `<td class="p-3 text-xs text-slate-700 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'desc', 'actions')">${item.desc}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'owner', 'actions')">${item.owner}</td>`;
                    cells += `<td class="p-3 text-xs text-slate-600 cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'due', 'actions')">${item.due}</td>`;
                    
                    // NEW: Display Updated Date (truncated)
                    const updatedStr = item.updated ? item.updated.split('T')[0] : '-';
                    cells += `<td class="p-3 text-xs text-slate-400 cursor-default" title="Created: ${item.created || '-'}">${updatedStr}</td>`;
                    
                    cells += `<td class="p-3 text-xs font-bold ${item.status==='Done'?'text-emerald-600':'text-amber-600'} cursor-pointer hover:bg-indigo-50" onclick="window.makeEditableRAID(this, ${item.id}, 'status', 'actions')">${item.status}</td>`;
                }

                // FIXED: Standard onclick using global window function
                cells += `<td class="p-3 text-center"><button type="button" data-action="delete-raid" data-table="${type}" data-id="${item.id}" class="text-slate-400 hover:text-rose-600 group"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td>`;
                
                tr.innerHTML = cells;
                tbody.appendChild(tr);
            });
        }

        // --- INIT & RENDER ---
        window.addEventListener('load', () => {
            initData();
            refreshView();
            enableColumnResizing(); 
            enablePanelResizing();
            
            // --- FIXED: GLOBAL EVENT DELEGATION FOR DELETION ---
            document.body.addEventListener('click', function(e) {
                const btn = e.target.closest('button[data-action="delete-raid"]');
                if (btn) {
                    e.preventDefault();
                    const tableType = btn.getAttribute('data-table');
                    const itemId = parseInt(btn.getAttribute('data-id'));
                    window.openConfirmModal(`Delete item ${itemId} from ${tableType}?`, () => {
                        raidData[tableType] = raidData[tableType].filter(i => i.id !== itemId);
                        renderRAIDTable(tableType);
                        if(window.updateStatusDropdown) window.updateStatusDropdown(tableType);
                    });
                }
            });
            
            const grid = document.getElementById('grid-scroll');
            const chart = document.getElementById('chart-scroll');
            const header = document.getElementById('axis-wrapper');
            let isSyncing = false;

            const syncVertical = (source, target) => {
                if(!isSyncing) { isSyncing = true; target.scrollTop = source.scrollTop; isSyncing = false; }
            };
            grid.onscroll = () => syncVertical(grid, chart);
            chart.onscroll = () => {
                syncVertical(chart, grid);
                header.style.left = `-${chart.scrollLeft}px`; 
            };
        });

        function refreshView() {
            calculateSchedule();
            calculateCriticalPath();
            renderTable();
            try { renderChart(); } catch(e) { console.warn("Chart render skipped", e); }
            document.getElementById('task-count').innerText = projectData.length;
        }

        function renderTable() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            projectData.forEach((task, index) => {
                if(!isRowVisible(index)) return;

                const endStr = new Date(new Date(task.start).getTime() + (task.dur * 86400000)).toISOString().split('T')[0];
                const row = document.createElement('tr');
                row.className = 'gantt-row hover:bg-slate-50 transition-colors group';
                
                const paddingLeft = (task.indent || 0) * 20 + 8;
                const isParent = projectData.some(t => t.indent > task.indent && projectData.indexOf(t) > index);
                const toggleIcon = collapsedParents.has(task.id) ? '+' : '−';
                const toggleVisibility = isParent || (index < projectData.length -1 && projectData[index+1].indent > task.indent) ? 'visible' : 'hidden';

                const isDateDisabled = task.parent !== null;
                const dateClass = isDateDisabled ? "bg-slate-50 text-slate-400 cursor-not-allowed" : "editable";
                const dateClick = isDateDisabled ? "" : `onclick="makeEditable(this, ${task.id}, 'start')"`;

                // Calculate if this task is linked to an action
                const isLinked = task.linkedActionId ? 'checked' : '';

                row.innerHTML = `
                    <td class="font-mono text-xs text-slate-400 font-bold text-center border-r border-slate-100">${task.id}</td>
                    <td class="border-r border-slate-100 relative editable" style="height:40px;">
                        <div class="flex items-center h-full">
                            <span class="toggle-btn" style="visibility:${toggleVisibility}; margin-left:${paddingLeft - 16}px" onclick="toggleCollapse(${task.id}); event.stopPropagation();">${toggleIcon}</span>
                            <div class="truncate-text font-medium text-slate-700 text-xs flex-grow" style="padding-left: 4px;" onclick="openTaskModal(${task.id})">${task.name}</div>
                        </div>
                    </td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'parent')">${task.parent || '-'}</td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'depType')">${task.depType || 'FS'}</td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'dur')">${task.dur}d</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100 whitespace-nowrap ${dateClass}" ${dateClick}>${task.start}</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100 bg-slate-50 text-slate-400 cursor-not-allowed whitespace-nowrap" title="Auto-Calculated">${endStr}</td>
                    <td class="text-center border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'pct')">
                        <span class="text-[9px] font-bold text-slate-400">${task.pct}%</span>
                    </td>
                    <!-- New Track Checkbox Cell -->
                    <td class="text-center border-r border-slate-100">
                        <input type="checkbox" ${isLinked} onchange="window.toggleTaskAction(${task.id}, this.checked)" class="accent-indigo-600 cursor-pointer w-3.5 h-3.5">
                    </td>
                    <td class="text-center border-r border-slate-100">
                        <div class="flex items-center justify-center h-full gap-1">
                            <button onclick="openTaskModal(${task.id}, 'edit')" class="btn-icon" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                            <button onclick="openTaskModal(${task.id}, 'subtask')" class="btn-icon text-indigo-600 font-bold" title="Add Child">↳</button>
                            <button onclick="modifyIndent(${task.id}, -1)" class="btn-icon" title="Outdent">&larr;</button>
                            <button onclick="modifyIndent(${task.id}, 1)" class="btn-icon" title="Indent">&rarr;</button>
                            <button onclick="deleteTask(${task.id})" class="btn-icon-danger" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function makeEditable(cell, id, field) {
            if (cell.querySelector('input, select')) return;
            const task = projectData.find(t => t.id === id);
            if (!task) return;

            const currentValue = task[field];
            cell.classList.add('editing');
            
            let inputHTML = '';
             if (field === 'start') {
                inputHTML = `<input type="date" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else if (field === 'depType') {
                inputHTML = `<select onblur="commitEdit(${id}, '${field}', this.value)" class="w-full text-xs bg-slate-100">
                    <option value="FS" ${currentValue==='FS'?'selected':''}>FS</option>
                    <option value="SS" ${currentValue==='SS'?'selected':''}>SS</option>
                    <option value="FF" ${currentValue==='FF'?'selected':''}>FF</option>
                    <option value="SF" ${currentValue==='SF'?'selected':''}>SF</option>
                </select>`;
            } else if (field === 'name') {
                inputHTML = `<input type="text" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else {
                inputHTML = `<input type="number" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            }
            
            cell.innerHTML = inputHTML;
            const input = cell.querySelector('input, select');
            if(input) input.focus();
        }

        function commitEdit(id, field, value) {
            const task = projectData.find(t => t.id === id);
            if (!task) return;
            
            if (field === 'dur') task.dur = parseInt(value) || 0;
            else if (field === 'pct') task.pct = Math.min(100, Math.max(0, parseInt(value) || 0));
            else if (field === 'parent') task.parent = value ? parseInt(value) : null;
            else if (field === 'depType') task.depType = value;
            else if (field === 'start') task.start = value;
            else task[field] = value;
            
            refreshView();
        }

        let chartInstance = null;
        let axisInstance = null;

        function renderChart() {
            if(projectData.length === 0) {
                if(chartInstance) chartInstance.destroy();
                if(axisInstance) axisInstance.destroy();
                return;
            }

            const visibleTasks = [];
            projectData.forEach((t, i) => { if(isRowVisible(i)) visibleTasks.push(t); });

            const ROW_HEIGHT = 36; 
            document.getElementById('chart-container').style.height = `${visibleTasks.length * ROW_HEIGHT}px`;
            
            const ctx = document.getElementById('ganttCanvas').getContext('2d');
            const axisCtx = document.getElementById('axisCanvas').getContext('2d');

            if (chartInstance) chartInstance.destroy();
            if (axisInstance) axisInstance.destroy();

            const baselineData = visibleTasks.map(t => {
                if(!showBaseline) return { x: null, y: `Row ${t.id}` };
                const s = new Date(t.baseStart);
                const e = new Date(s.getTime() + ((t.baseDur || 0.5) * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}` };
            });

            const actualData = visibleTasks.map(t => {
                const s = new Date(t.start);
                const displayDur = t.type === 'Milestone' ? 0.5 : t.dur;
                const e = new Date(s.getTime() + (displayDur * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}`, status: t.pct };
            });

            // Width & Scale Calculation based on View Mode
            const minDate = new Date("2026-01-08");
            let maxDate = minDate;
            projectData.forEach(t => {
                const end = new Date(t.start);
                end.setDate(end.getDate() + (t.dur || 1));
                if (end > maxDate) maxDate = end;
            });
            maxDate = new Date(maxDate.getTime() + (45 * 86400000)); 

            const daysSpan = (maxDate - minDate) / 86400000;
            
            let pixelsPerDay = 20;
            let timeUnit = 'week';
            
            if (viewMode === '2week') {
                pixelsPerDay = 10; // More compressed
                timeUnit = 'week';
            } else if (viewMode === 'month') {
                pixelsPerDay = 4; // Very compressed
                timeUnit = 'month';
            }

            const requiredWidth = Math.max(document.getElementById('chart-scroll').clientWidth, daysSpan * pixelsPerDay);

            document.getElementById('chart-container').style.width = `${requiredWidth}px`;
            document.getElementById('axis-wrapper').style.width = `${requiredWidth}px`;

            const sharedOptions = {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                layout: { padding: { left: 0, right: 20 } },
                plugins: { legend: { display: false }, tooltip: { enabled: true } },
                scales: {
                    x: { 
                        // FIX: Hide ticks on the main chart to prevent "Double Header" effect
                        type: 'time', time: { unit: timeUnit }, 
                        min: minDate.valueOf(), max: maxDate.valueOf(),
                        position: 'top', 
                        grid: { color: '#E2E8F0' }, 
                        ticks: { display: false } 
                    },
                    y: { display: false, grid: { display: false } }
                }
            };

            // Main Chart
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: visibleTasks.map(t => `Row ${t.id}`),
                    datasets: [
                        { label: 'Baseline', data: baselineData, backgroundColor: '#94A3B8', barThickness: 4, grouped: false, order: 1 },
                        { label: 'Actual', data: actualData, backgroundColor: (ctx) => {
                            const dataIndex = ctx.dataIndex;
                            if (dataIndex === undefined || dataIndex < 0) return '#CBD5E1';
                            const task = visibleTasks[dataIndex];
                            if (task.type === 'Milestone') return 'rgba(0,0,0,0)'; 
                            const pct = ctx.raw?.status;
                            if(pct === 100) return '#10B981'; if(pct > 0) return '#F59E0B'; return '#CBD5E1';
                        }, borderRadius: 3, barPercentage: 0.6, grouped: false, order: 0 }
                    ]
                },
                options: {
                    ...sharedOptions,
                    layout: { padding: { top: 0, bottom: 0, left: 0, right: 20 } },
                    scales: {
                        x: { 
                            // FIX: Hide ticks on the main chart to prevent "Double Header" effect
                            type: 'time', time: { unit: timeUnit }, 
                            min: minDate.valueOf(), max: maxDate.valueOf(),
                            position: 'top', 
                            grid: { color: '#E2E8F0' }, 
                            ticks: { display: false } 
                        },
                        y: { display: false, grid: { display: false } }
                    }
                },
                plugins: [{
                    id: 'weekendHighlighter',
                    beforeDraw(chart) {
                        // Only draw weekends if we aren't in month view (too cluttered)
                        if (viewMode === 'month') return;

                        const { ctx, scales: { x } } = chart;
                        const start = new Date(x.min);
                        const end = new Date(x.max);
                        
                        ctx.fillStyle = 'rgba(241, 245, 249, 0.4)'; // Slight gray for weekends
                        
                        // Loop days
                        let current = new Date(start);
                        while(current <= end) {
                            const day = current.getDay();
                            if(day === 0 || day === 6) { // Sun or Sat
                                const xStart = x.getPixelForValue(current.getTime());
                                const nextDay = new Date(current); nextDay.setDate(nextDay.getDate() + 1);
                                const xEnd = x.getPixelForValue(nextDay.getTime());
                                ctx.fillRect(xStart, 0, xEnd - xStart, chart.height);
                            }
                            current.setDate(current.getDate() + 1);
                        }
                    }
                },
                {
                    id: 'dependencyLines',
                    // Draw lines BEFORE datasets so they are behind the bars
                    beforeDatasetsDraw(chart) {
                        const { ctx } = chart;
                        const meta = chart.getDatasetMeta(1); // Actual data
                        const idToIndex = {}; visibleTasks.forEach((t, i) => idToIndex[t.id] = i);
                        
                        ctx.save(); ctx.lineJoin = 'round'; ctx.lineCap = 'round';
                        
                        visibleTasks.forEach((task, index) => {
                            if (task.parent && idToIndex[task.parent] !== undefined) {
                                const pIdx = idToIndex[task.parent];
                                // Skip drawing if parent is hidden (collapsed) or logic implies root
                                if (task.type === 'Milestone' || visibleTasks[pIdx].type === 'Milestone') return;

                                const pBar = meta.data[pIdx];
                                const cBar = meta.data[index];
                                if (!pBar || !cBar) return;

                                const isCrit = criticalPathSet.has(task.id) && criticalPathSet.has(task.parent);

                                ctx.strokeStyle = isCrit ? '#9333EA' : '#94A3B8';
                                ctx.lineWidth = isCrit ? 2 : 1;
                                if (!isCrit) ctx.setLineDash([2, 4]); else ctx.setLineDash([]);

                                const startY = pBar.y; const endY = cBar.y;
                                
                                // Simple FS logic for drawing (Connect Right of parent to Left of child)
                                const startX = pBar.x; 
                                const endX = cBar.base; 

                                ctx.beginPath();
                                ctx.moveTo(startX, startY);
                                const cp1x = startX + 15; const cp2x = endX - 15;
                                ctx.bezierCurveTo(cp1x, startY, cp2x, endY, endX, endY);
                                ctx.stroke();
                                
                                // Arrowhead
                                ctx.beginPath();
                                ctx.fillStyle = ctx.strokeStyle;
                                ctx.moveTo(endX, endY);
                                ctx.lineTo(endX - 5, endY - 3);
                                ctx.lineTo(endX - 5, endY + 3);
                                ctx.fill();
                            }
                        });

                        // Draw Milestones (Diamonds)
                        visibleTasks.forEach((task, index) => {
                            if (task.type === 'Milestone') {
                                const bar = meta.data[index];
                                if (!bar) return;
                                const x = bar.base; 
                                const y = bar.y;
                                const size = 6;
                                ctx.beginPath();
                                ctx.fillStyle = task.pct === 100 ? '#10B981' : '#F59E0B';
                                ctx.moveTo(x, y - size);
                                ctx.lineTo(x + size, y);
                                ctx.lineTo(x, y + size);
                                ctx.lineTo(x - size, y);
                                ctx.fill();
                                ctx.stroke();
                            }
                        });
                        ctx.restore();
                    }
                }]
            });
            
            // Axis Chart (Header)
            axisInstance = new Chart(axisCtx, {
                type: 'bar',
                data: { labels: [''], datasets: [] },
                options: {
                    ...sharedOptions,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { 
                            type: 'time', time: { unit: timeUnit }, 
                            min: minDate.valueOf(), max: maxDate.valueOf(),
                            position: 'top', 
                            grid: { color: '#E2E8F0' }, 
                            ticks: { font: { size: 10, weight: 'bold' }, color: '#64748B', maxRotation: 0, autoSkip: true } 
                        },
                        y: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
