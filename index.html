<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD-WAN Gantt Chart MVP</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F1F5F9; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Alignment Constants */
        :root {
            --row-height: 40px;
            --header-height: 48px;
        }

        .gantt-row { height: var(--row-height); border-bottom: 1px solid #F1F5F9; box-sizing: border-box; }
        .gantt-header { height: var(--header-height); background: #F8FAFC; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #E2E8F0; }
        
        /* Table Typography */
        th { 
            white-space: nowrap; font-size: 0.7rem; color: #64748B; 
            text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; text-align: left; padding: 0 8px;
        }
        td { 
            white-space: nowrap; font-size: 0.75rem; color: #334155; 
            padding: 0 8px; vertical-align: middle; 
        }
        
        /* Editable Cells */
        .editable { cursor: pointer; transition: background-color 0.15s; }
        .editable:hover { background-color: #F1F5F9; color: #4F46E5; }
        .editing { padding: 0 !important; }
        .editing input { width: 100%; height: 100%; border: 2px solid #6366F1; padding: 0 8px; font-size: 0.75rem; outline: none; background: #EEF2FF; }

        .truncate-text { max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        .btn-icon { @apply p-1 rounded text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 transition-colors cursor-pointer; }
        .btn-icon-danger { @apply p-1 rounded text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition-colors cursor-pointer; }

        /* Modal Styles */
        #taskModal { transition: opacity 0.2s ease-in-out; }
        #taskModal.hidden { pointer-events: none; opacity: 0; }
        #taskModal:not(.hidden) { pointer-events: auto; opacity: 1; }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="flex-none bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center z-30 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">P</div>
            <div>
                <h1 class="text-lg font-bold text-slate-900 leading-tight">SD-WAN Project Plan</h1>
                <p class="text-xs text-slate-500">Gantt MVP | <span id="task-count">72</span> Tasks</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Baseline Controls -->
            <div class="flex items-center gap-2 mr-4 border-r border-slate-200 pr-4">
                <button onclick="setBaseline()" class="text-[10px] font-bold uppercase text-slate-500 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded transition-colors" title="Snapshot current schedule as baseline">
                    Set Baseline
                </button>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="showBaselineToggle" checked onchange="toggleBaseline()" class="form-checkbox h-3 w-3 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <span class="text-[10px] font-bold uppercase text-slate-500">Show Baseline</span>
                </label>
            </div>

            <!-- Legend -->
            <div class="hidden md:flex items-center gap-4 text-[10px] uppercase font-bold text-slate-500 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span> Not Started</div>
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-amber-500"></span> In Progress</div>
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span> Complete</div>
                <div class="w-px h-3 bg-slate-300 mx-1"></div>
                <div class="flex items-center gap-1.5"><span class="w-4 h-1 bg-gray-400"></span> Baseline</div>
                <div class="flex items-center gap-1.5"><span class="w-6 h-0.5 bg-purple-600"></span> Critical</div>
            </div>

            <!-- Add Task Button -->
            <button onclick="openTaskModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm flex items-center gap-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Task
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-grow flex overflow-hidden">
        
        <!-- LEFT: Data Table -->
        <div class="flex-none w-[50%] max-w-[800px] border-r border-slate-200 bg-white flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="flex-grow overflow-auto" id="grid-scroll">
                <table class="w-full border-collapse">
                    <thead class="gantt-header">
                        <tr>
                            <th class="w-10 text-center">ID</th>
                            <th>Task Name</th>
                            <th class="w-10 text-center" title="Dependency">Dep</th>
                            <th class="w-12 text-center">Dur</th>
                            <th class="w-20">Start</th>
                            <th class="w-20">Finish</th>
                            <th class="w-12 text-center">%</th>
                            <th class="w-10 text-center"></th>
                        </tr>
                    </thead>
                    <tbody id="grid-body"></tbody>
                </table>
            </div>
        </div>

        <!-- RIGHT: Gantt Chart -->
        <div class="flex-grow flex flex-col bg-white relative min-w-0">
            <div class="flex-grow overflow-auto" id="chart-scroll">
                <div id="chart-container" class="relative w-full">
                    <canvas id="ganttCanvas"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal -->
    <div id="taskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Add New Task</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Task Name</label>
                    <input type="text" id="m-name" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                        <select id="m-type" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="design">Design Task</option>
                            <option value="procure">Procurement</option>
                            <option value="logistics">Logistics</option>
                            <option value="rollout">Rollout</option>
                            <option value="admin">Admin/Other</option>
                            <option value="gate">Gate</option>
                            <option value="milestone">Milestone</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Predecessor ID</label>
                        <input type="number" id="m-parent" placeholder="Optional" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                        <input type="date" id="m-start" class="w-full border border-slate-300 rounded px-2 py-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Duration (Days)</label>
                        <input type="number" id="m-dur" value="1" min="0" class="w-full border border-slate-300 rounded px-2 py-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Finish Date</label>
                        <input type="date" id="m-finish" class="w-full border border-slate-300 rounded px-2 py-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">% Complete</label>
                        <input type="number" id="m-pct" value="0" min="0" max="100" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div id="div-insert">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Insert After</label>
                        <select id="m-insert" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="end">-- End of List --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="saveTask()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATASET ---
        let projectData = [
            { id: 1, name: "Project Plan Root", parent: null, start: "2026-01-08", dur: 0, type: "root", pct: 100 },
            { id: 3, name: "Contract & PO Signed", parent: 1, start: "2026-01-08", dur: 0, type: "milestone", pct: 100 },
            { id: 4, name: "Gate 1: Kick Off", parent: 1, start: "2026-02-04", dur: 1, type: "gate", pct: 100 },
            { id: 5, name: "Gate 2: Discovery", parent: 4, start: "2026-03-10", dur: 1, type: "gate", pct: 20 },
            { id: 6, name: "Gate 3: Pilot", parent: 5, start: "2026-03-20", dur: 1, type: "gate", pct: 0 },
            { id: 7, name: "Gate 4: Rollout", parent: 6, start: "2026-04-27", dur: 1, type: "gate", pct: 0 },
            { id: 8, name: "Gate 5: Closure", parent: 7, start: "2026-05-04", dur: 1, type: "gate", pct: 0 },
            { id: 10, name: "Confirm Final Design", parent: 1, start: "2026-01-09", dur: 3, type: "design", pct: 100 },
            { id: 11, name: "Prepare SSD & Cabling", parent: 10, start: "2026-01-14", dur: 2, type: "design", pct: 100 },
            { id: 12, name: "Enter Orders (GTT)", parent: 10, start: "2026-01-14", dur: 10, type: "procure", pct: 90 },
            { id: 13, name: "MSA Signature", parent: 10, start: "2026-01-14", dur: 12, type: "design", pct: 80 },
            { id: 14, name: "PON Re-signing", parent: 12, start: "2026-01-28", dur: 5, type: "procure", pct: 50 },
            { id: 15, name: "Orders Validated", parent: 14, start: "2026-02-04", dur: 2, type: "procure", pct: 0 },
            { id: 16, name: "EnvisionEdge Cert", parent: 1, start: "2026-01-09", dur: 6, type: "design", pct: 100 },
            { id: 18, name: "Internal Acceptance", parent: 15, start: "2026-02-06", dur: 3, type: "admin", pct: 0 },
            { id: 19, name: "PON Validation", parent: 18, start: "2026-02-11", dur: 1, type: "admin", pct: 0 },
            { id: 20, name: "External Kick Off", parent: 19, start: "2026-02-12", dur: 2, type: "admin", pct: 0 },
            { id: 21, name: "PID Agreed", parent: 20, start: "2026-02-16", dur: 2, type: "admin", pct: 0 },
            { id: 22, name: "Plan Created", parent: 16, start: "2026-01-19", dur: 2, type: "admin", pct: 100 },
            { id: 23, name: "Tracker Created", parent: 16, start: "2026-01-19", dur: 2, type: "admin", pct: 100 },
            { id: 24, name: "RAID Log Created", parent: 16, start: "2026-01-19", dur: 2, type: "admin", pct: 100 },
            { id: 26, name: "Share SSD/HLD", parent: 16, start: "2026-01-19", dur: 8, type: "design", pct: 60 },
            { id: 27, name: "Share TAD", parent: 15, start: "2026-02-06", dur: 2, type: "design", pct: 0 },
            { id: 28, name: "Update IP Addresses", parent: 12, start: "2026-01-28", dur: 1, type: "design", pct: 0 },
            { id: 30, name: "TAD Approved", parent: 27, start: "2026-02-10", dur: 2, type: "design", pct: 0 },
            { id: 31, name: "Schedule Workshops", parent: 27, start: "2026-02-10", dur: 2, type: "design", pct: 0 },
            { id: 32, name: "Config Review (Workshops)", parent: 27, start: "2026-02-10", dur: 20, type: "design", pct: 0 },
            { id: 33, name: "Agree Solution", parent: 32, start: "2026-03-10", dur: 5, type: "design", pct: 0 },
            { id: 34, name: "Client Tech Info", parent: 28, start: "2026-01-29", dur: 15, type: "design", pct: 10 },
            { id: 36, name: "NetProv Confirm", parent: 15, start: "2026-02-06", dur: 0, type: "logistics", pct: 0 },
            { id: 37, name: "Pilot Pre-stage", parent: 28, start: "2026-01-29", dur: 6, type: "logistics", pct: 20 },
            { id: 38, name: "Pilot Shipment", parent: 37, start: "2026-02-06", dur: 15, type: "logistics", pct: 0 },
            { id: 39, name: "Rollout Pre-stage", parent: 27, start: "2026-02-10", dur: 10, type: "logistics", pct: 0 },
            { id: 40, name: "Rollout Shipment", parent: 39, start: "2026-02-24", dur: 15, type: "logistics", pct: 0 },
            { id: 42, name: "Identify Pilot Sites", parent: 21, start: "2026-02-18", dur: 1, type: "design", pct: 0 },
            { id: 43, name: "Final Workshop", parent: 38, start: "2026-02-27", dur: 3, type: "design", pct: 0 },
            { id: 44, name: "Final LLDs", parent: 43, start: "2026-03-04", dur: 1, type: "design", pct: 0 },
            { id: 45, name: "Define Success Scope", parent: 33, start: "2026-03-17", dur: 5, type: "design", pct: 0 },
            { id: 46, name: "Determine UAT", parent: 33, start: "2026-03-17", dur: 5, type: "design", pct: 0 },
            { id: 47, name: "Create Runbook", parent: 43, start: "2026-03-04", dur: 1, type: "design", pct: 0 },
            { id: 49, name: "Site 1 Mig", parent: 44, start: "2026-03-05", dur: 1, type: "rollout", pct: 0 },
            { id: 50, name: "Site 2 Mig", parent: 49, start: "2026-03-06", dur: 2, type: "rollout", pct: 0 },
            { id: 51, name: "Site 3 Mig", parent: 50, start: "2026-03-10", dur: 2, type: "rollout", pct: 0 },
            { id: 52, name: "Design Signed", parent: 51, start: "2026-03-12", dur: 5, type: "design", pct: 0 },
            { id: 53, name: "Create DDD", parent: 52, start: "2026-03-19", dur: 1, type: "design", pct: 0 },
            { id: 54, name: "Handover Net Prov", parent: 53, start: "2026-03-20", dur: 1, type: "admin", pct: 0 },
            { id: 56, name: "Site 3 Rollout", parent: 54, start: "2026-03-23", dur: 5, type: "rollout", pct: 0 },
            { id: 57, name: "Site 4 Rollout", parent: 56, start: "2026-03-30", dur: 2, type: "rollout", pct: 0 },
            { id: 58, name: "Site 5 Rollout", parent: 57, start: "2026-04-01", dur: 2, type: "rollout", pct: 0 },
            { id: 59, name: "Site 6 Rollout", parent: 58, start: "2026-04-03", dur: 2, type: "rollout", pct: 0 },
            { id: 60, name: "Site 7 Rollout", parent: 59, start: "2026-04-07", dur: 2, type: "rollout", pct: 0 },
            { id: 61, name: "Site 8 Rollout", parent: 60, start: "2026-04-09", dur: 2, type: "rollout", pct: 0 },
            { id: 62, name: "Site 9 Rollout", parent: 61, start: "2026-04-13", dur: 2, type: "rollout", pct: 0 },
            { id: 63, name: "Site 10 Rollout", parent: 62, start: "2026-04-15", dur: 2, type: "rollout", pct: 0 },
            { id: 64, name: "Site 11 Rollout", parent: 63, start: "2026-04-17", dur: 2, type: "rollout", pct: 0 },
            { id: 65, name: "Site 12 Rollout", parent: 64, start: "2026-04-21", dur: 2, type: "rollout", pct: 0 },
            { id: 66, name: "Site 13 Rollout", parent: 65, start: "2026-04-23", dur: 2, type: "rollout", pct: 0 },
            { id: 67, name: "Site 14 Rollout", parent: 66, start: "2026-04-27", dur: 2, type: "rollout", pct: 0 },
            { id: 68, name: "EnvisionDX Access", parent: 49, start: "2026-03-06", dur: 1, type: "admin", pct: 0 },
            { id: 69, name: "Service Reviews", parent: 49, start: "2026-03-06", dur: 1, type: "admin", pct: 0 },
            { id: 71, name: "Lessons Learned", parent: 67, start: "2026-04-29", dur: 3, type: "admin", pct: 0 },
            { id: 72, name: "Project Closed", parent: 71, start: "2026-05-04", dur: 2, type: "gate", pct: 0 }
        ];

        // --- 2. LOGIC: CRITICAL PATH & BASELINE ---
        const criticalPathSet = new Set();
        let showBaseline = true;

        // Init Data: Ensure every task has a baseline property equal to initial state
        function initData() {
            projectData.forEach(t => {
                if (!t.baseStart) t.baseStart = t.start;
                if (!t.baseDur) t.baseDur = t.dur;
            });
        }

        function calculateCriticalPath() {
            criticalPathSet.clear();
            let currentId = 72;
            while (currentId) {
                criticalPathSet.add(currentId);
                const task = projectData.find(t => t.id === currentId);
                currentId = task ? task.parent : null;
            }
        }

        function setBaseline() {
            if(confirm("Overwrite Baseline with Current Schedule?")) {
                projectData.forEach(t => {
                    t.baseStart = t.start;
                    t.baseDur = t.dur;
                });
                renderChart(); // Re-render to update baseline bars
            }
        }

        function toggleBaseline() {
            showBaseline = document.getElementById('showBaselineToggle').checked;
            renderChart();
        }

        // --- 3. MODAL & EDIT LOGIC ---
        let editingId = null;

        // Initialize Modal Logic
        window.addEventListener('load', () => {
            initData();
            calculateCriticalPath();
            renderTable();
            renderChart();
            
            // ... (sync scrolling code below)
            const mStart = document.getElementById('m-start');
            const mDur = document.getElementById('m-dur');
            const mFinish = document.getElementById('m-finish');

            function updateFinish() {
                if(mStart.value) {
                    const start = new Date(mStart.value);
                    const days = parseInt(mDur.value) || 0;
                    const end = new Date(start.getTime() + (days * 86400000));
                    mFinish.value = end.toISOString().split('T')[0];
                }
            }

            function updateDuration() {
                if(mStart.value && mFinish.value) {
                    const start = new Date(mStart.value);
                    const end = new Date(mFinish.value);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    mDur.value = diffDays;
                }
            }

            mStart.addEventListener('change', updateFinish);
            mDur.addEventListener('input', updateFinish);
            mFinish.addEventListener('change', updateDuration);
            
            // Sync Scrolling
            const grid = document.getElementById('grid-scroll');
            const chart = document.getElementById('chart-scroll');
            let isSyncingLeft = false;
            let isSyncingRight = false;

            grid.addEventListener('scroll', function(e) {
                if (!isSyncingLeft) {
                    isSyncingRight = true;
                    chart.scrollTop = this.scrollTop;
                }
                isSyncingLeft = false;
            });

            chart.addEventListener('scroll', function(e) {
                if (!isSyncingRight) {
                    isSyncingLeft = true;
                    grid.scrollTop = this.scrollTop;
                }
                isSyncingRight = false;
            });
        });

        function openTaskModal(id = null) {
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('modalTitle');
            const insertDiv = document.getElementById('div-insert');
            const insertSelect = document.getElementById('m-insert');
            
            insertSelect.innerHTML = '<option value="end">-- End of List --</option>';
            projectData.forEach((t, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = `After: [${t.id}] ${t.name.substring(0,30)}...`;
                insertSelect.appendChild(opt);
            });

            editingId = id;

            if (id) {
                title.innerText = "Edit Task Details";
                insertDiv.classList.add('hidden');
                
                const task = projectData.find(t => t.id === id);
                document.getElementById('m-name').value = task.name;
                document.getElementById('m-type').value = task.type;
                document.getElementById('m-parent').value = task.parent || '';
                document.getElementById('m-start').value = task.start;
                document.getElementById('m-dur').value = task.dur;
                document.getElementById('m-pct').value = task.pct;
                
                const start = new Date(task.start);
                const end = new Date(start.getTime() + (task.dur * 86400000));
                document.getElementById('m-finish').value = end.toISOString().split('T')[0];

            } else {
                title.innerText = "Add New Task";
                insertDiv.classList.remove('hidden');
                
                document.getElementById('m-name').value = "";
                document.getElementById('m-type').value = "design";
                document.getElementById('m-parent').value = "";
                document.getElementById('m-start').value = "2026-01-08";
                document.getElementById('m-dur').value = "1";
                document.getElementById('m-pct').value = "0";
                document.getElementById('m-finish').value = "2026-01-09";
            }
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.add('hidden');
        }

        function saveTask() {
            const name = document.getElementById('m-name').value || "New Task";
            const type = document.getElementById('m-type').value;
            const dur = parseInt(document.getElementById('m-dur').value) || 0;
            const start = document.getElementById('m-start').value;
            const pct = parseInt(document.getElementById('m-pct').value) || 0;
            const parent = parseInt(document.getElementById('m-parent').value) || null;

            if (editingId) {
                const task = projectData.find(t => t.id === editingId);
                if (task) {
                    task.name = name;
                    task.type = type;
                    task.dur = dur;
                    task.start = start;
                    task.pct = pct;
                    task.parent = parent;
                }
            } else {
                const maxId = Math.max(...projectData.map(t => t.id));
                const newId = maxId + 1;
                const insertVal = document.getElementById('m-insert').value;
                
                const newTask = {
                    id: newId, name, type, dur, start, pct, parent, 
                    baseStart: start, baseDur: dur // Set baseline for new task equal to current
                };

                if (insertVal === "end") {
                    projectData.push(newTask);
                } else {
                    const index = parseInt(insertVal);
                    projectData.splice(index + 1, 0, newTask);
                }
            }

            refreshView();
            closeModal();
        }

        function deleteTask(id) {
            if(confirm(`Are you sure you want to delete Task ID ${id}?`)) {
                const index = projectData.findIndex(t => t.id === id);
                if (index > -1) {
                    projectData.splice(index, 1);
                    refreshView();
                }
            }
        }

        function refreshView() {
            calculateCriticalPath();
            renderTable();
            renderChart();
            updateCount();
        }

        function updateCount() {
            document.getElementById('task-count').innerText = projectData.length;
        }

        // --- INLINE EDITING LOGIC ---
        function makeEditable(cell, id, field) {
            if (cell.querySelector('input') || cell.classList.contains('editing')) return;

            const task = projectData.find(t => t.id === id);
            if (!task) return;

            const currentValue = task[field];
            cell.classList.add('editing');

            let inputHTML = '';
            
            if (field === 'finish') {
                const start = new Date(task.start);
                const end = new Date(start.getTime() + (task.dur * 86400000));
                const val = end.toISOString().split('T')[0];
                inputHTML = `<input type="date" value="${val}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else if (field === 'start') {
                inputHTML = `<input type="date" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else if (field === 'dur' || field === 'pct' || field === 'parent') {
                inputHTML = `<input type="number" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            } else { 
                inputHTML = `<input type="text" value="${currentValue}" onblur="commitEdit(${id}, '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur()">`;
            }

            cell.innerHTML = inputHTML;
            const input = cell.querySelector('input');
            input.focus();
        }

        function commitEdit(id, field, value) {
            const task = projectData.find(t => t.id === id);
            if (!task) return;

            if (field === 'dur') {
                task.dur = parseInt(value) || 0;
            } else if (field === 'pct') {
                task.pct = Math.min(100, Math.max(0, parseInt(value) || 0));
            } else if (field === 'parent') {
                task.parent = value ? parseInt(value) : null;
            } else if (field === 'start') {
                task.start = value;
            } else if (field === 'finish') {
                const start = new Date(task.start);
                const end = new Date(value);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                task.dur = diffDays;
            } else {
                task[field] = value;
            }

            refreshView();
        }

        // --- 4. RENDERING ---
        let chartInstance = null;

        function renderTable() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            
            projectData.forEach(task => {
                const startDate = new Date(task.start);
                const endDate = new Date(startDate.getTime() + (task.dur * 86400000));
                const endStr = endDate.toISOString().split('T')[0];
                
                const row = document.createElement('tr');
                row.className = 'gantt-row hover:bg-slate-50 transition-colors group';
                
                let pctColor = 'bg-slate-300';
                if(task.pct > 0) pctColor = 'bg-amber-500';
                if(task.pct === 100) pctColor = 'bg-emerald-500';

                row.innerHTML = `
                    <td class="font-mono text-xs text-slate-400 font-bold text-center border-r border-slate-100">${task.id}</td>
                    <td class="border-r border-slate-100 relative editable" onclick="makeEditable(this, ${task.id}, 'name')">
                        <div class="truncate-text font-medium text-slate-700 text-xs" title="${task.name}">
                            ${task.name}
                        </div>
                    </td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'parent')">${task.parent || '-'}</td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'dur')">${task.dur}d</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'start')">${task.start}</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'finish')">${endStr}</td>
                    <td class="text-center border-r border-slate-100 editable" onclick="makeEditable(this, ${task.id}, 'pct')">
                        <div class="flex items-center justify-center gap-1">
                            <div class="w-6 h-1 rounded-full bg-slate-100 overflow-hidden">
                                <div class="h-full ${pctColor}" style="width: ${task.pct}%"></div>
                            </div>
                            <span class="text-[9px] font-bold text-slate-400">${task.pct}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <button onclick="deleteTask(${task.id})" class="btn-icon-danger" title="Delete Task">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderChart() {
            const ROW_HEIGHT = 40;
            const HEADER_HEIGHT = 48;
            const totalHeight = (projectData.length * ROW_HEIGHT) + HEADER_HEIGHT;
            
            const container = document.getElementById('chart-container');
            container.style.height = `${totalHeight}px`;

            const ctx = document.getElementById('ganttCanvas').getContext('2d');

            if (chartInstance) chartInstance.destroy();

            // Dataset 0: Baseline (Behind)
            const baselineData = projectData.map(t => {
                if(!showBaseline) return { x: null, y: `Row ${t.id}` };
                const s = new Date(t.baseStart);
                const e = new Date(s.getTime() + ((t.baseDur || 0.5) * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}` };
            });

            // Dataset 1: Actual (Front)
            const actualData = projectData.map(t => {
                const s = new Date(t.start);
                const e = new Date(s.getTime() + ((t.dur || 0.5) * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}`, status: t.pct };
            });

            const yLabels = projectData.map((_, i) => `Row ${projectData[i].id}`);

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: yLabels,
                    datasets: [
                        {
                            label: 'Baseline',
                            data: baselineData,
                            backgroundColor: '#94A3B8', // Gray
                            barPercentage: 0.6,
                            categoryPercentage: 1.0,
                            barThickness: 4, // Thin bar
                            grouped: false, // Overlap
                            order: 1 // Draw behind
                        },
                        {
                            label: 'Actual',
                            data: actualData,
                            backgroundColor: (ctx) => {
                                const pct = ctx.raw?.status;
                                if(pct === 100) return '#10B981'; 
                                if(pct > 0) return '#F59E0B';     
                                return '#CBD5E1';                 
                            },
                            borderRadius: 3,
                            barPercentage: 0.6,
                            categoryPercentage: 1.0,
                            grouped: false,
                            order: 0 // Draw front
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 0, bottom: 0, left: 0, right: 20 } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            filter: (item) => item.datasetIndex === 1, // Only tooltips for Actual
                            callbacks: { 
                                title: (items) => projectData[items[0].dataIndex].name,
                                label: (item) => {
                                    const d = projectData[item.dataIndex];
                                    return `Actual: ${d.start} (${d.dur}d) | Baseline: ${d.baseStart} (${d.baseDur}d)`;
                                }
                            } 
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'week' },
                            position: 'top',
                            min: '2026-01-08',
                            grid: { color: '#F1F5F9' },
                            ticks: { font: { size: 10 }, color: '#94A3B8' }
                        },
                        y: { display: false, grid: { display: false } }
                    }
                },
                plugins: [{
                    id: 'dependencyArrows',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        const meta = chart.getDatasetMeta(1); // Use Actual dataset for arrows
                        const idToIndex = {};
                        projectData.forEach((t, i) => idToIndex[t.id] = i);

                        ctx.save();
                        ctx.lineJoin = 'round';
                        ctx.lineCap = 'round';

                        projectData.forEach((task, index) => {
                            if (task.parent && idToIndex[task.parent] !== undefined) {
                                const pIdx = idToIndex[task.parent];
                                const pBar = meta.data[pIdx];
                                const cBar = meta.data[index];

                                if (!pBar || !cBar) return;

                                const isCrit = criticalPathSet.has(task.id) && criticalPathSet.has(task.parent);

                                ctx.strokeStyle = isCrit ? '#9333EA' : '#CBD5E1'; 
                                ctx.lineWidth = isCrit ? 2 : 1;
                                if (!isCrit) ctx.setLineDash([]); 

                                const startX = pBar.x;
                                const startY = pBar.y;
                                const endX = cBar.base + 2; 
                                const endY = cBar.y;

                                ctx.beginPath();
                                ctx.moveTo(startX, startY);
                                ctx.bezierCurveTo(startX + 15, startY, endX - 15, endY, endX, endY);
                                ctx.stroke();

                                ctx.beginPath();
                                ctx.fillStyle = ctx.strokeStyle;
                                ctx.moveTo(endX, endY);
                                ctx.lineTo(endX - 4, endY - 3);
                                ctx.lineTo(endX - 4, endY + 3);
                                ctx.fill();
                            }
                        });
                        ctx.restore();
                    }
                }]
            });
        }

        // --- NEW STATUS COLOR LOGIC ---
        function getStatusColor(pct) {
            if (pct === 100) return '#10B981'; // Green - Completed
            if (pct > 0) return '#F59E0B';     // Amber - In Progress
            return '#94A3B8';                 // Grey - Not Started
        }
    </script>
</body>
</html>
