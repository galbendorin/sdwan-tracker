<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD-WAN Gantt Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F1F5F9; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Alignment Constants */
        :root {
            --row-height: 40px;
            --header-height: 48px;
        }

        .gantt-row { height: var(--row-height); border-bottom: 1px solid #F1F5F9; box-sizing: border-box; }
        .gantt-header { height: var(--header-height); background: #F8FAFC; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #E2E8F0; }
        
        th { 
            white-space: nowrap; font-size: 0.7rem; color: #64748B; 
            text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; text-align: left; padding: 0 8px;
        }
        td { 
            white-space: nowrap; font-size: 0.75rem; color: #334155; 
            padding: 0 8px; vertical-align: middle; 
        }
        
        /* Editable Cells */
        .editable { cursor: pointer; transition: background-color 0.15s; }
        .editable:hover { background-color: #F1F5F9; color: #4F46E5; }
        .editing { padding: 0 !important; }
        .editing input, .editing select { width: 100%; height: 100%; border: 2px solid #6366F1; padding: 0 8px; font-size: 0.75rem; outline: none; background: #EEF2FF; }

        .truncate-text { max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        .btn-icon { @apply p-1 rounded text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 transition-colors cursor-pointer; }
        .btn-icon-danger { @apply p-1 rounded text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition-colors cursor-pointer; }

        /* Modal Styles */
        .modal-overlay { 
            background-color: rgba(0, 0, 0, 0.2); 
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="flex-none bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center z-30 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">P</div>
            <div>
                <h1 class="text-lg font-bold text-slate-900 leading-tight">SD-WAN Project Plan</h1>
                <p class="text-xs text-slate-500">Pro Gantt | <span id="task-count">72</span> Items</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Data Controls -->
            <div class="flex items-center gap-2 mr-2">
                <button onclick="downloadCSV()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-3 py-1.5 rounded transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Export CSV
                </button>
                <button onclick="document.getElementById('fileImport').click()" class="text-[10px] font-bold uppercase text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-3 py-1.5 rounded transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    Import CSV
                </button>
                <input type="file" id="fileImport" accept=".csv" class="hidden" onchange="importCSV(this)">
            </div>

            <!-- Baseline Controls -->
            <div class="flex items-center gap-2 mr-4 border-l border-r border-slate-200 px-4">
                <button onclick="setBaseline()" class="text-[10px] font-bold uppercase text-slate-500 hover:text-rose-600 bg-slate-50 hover:bg-rose-50 px-3 py-1.5 rounded transition-colors" title="Overwrite current baseline with active schedule">
                    Re-Baseline
                </button>
                <label class="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" id="showBaselineToggle" checked onchange="toggleBaseline()" class="form-checkbox h-3 w-3 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <span class="text-[10px] font-bold uppercase text-slate-500">Show Baseline</span>
                </label>
            </div>

            <!-- Legend -->
            <div class="hidden xl:flex items-center gap-4 text-[10px] uppercase font-bold text-slate-500 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span> Not Started</div>
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-amber-500"></span> In Progress</div>
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span> Complete</div>
                <div class="w-px h-3 bg-slate-300 mx-1"></div>
                <div class="flex items-center gap-1.5 transform rotate-45"><span class="w-2 h-2 bg-slate-800"></span></div> Milestone
                <div class="flex items-center gap-1.5"><span class="w-6 h-0.5 bg-purple-600"></span> Critical</div>
            </div>

            <!-- Add Task Button -->
            <button onclick="openTaskModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm flex items-center gap-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Task
            </button>

            <!-- Report Button -->
            <button onclick="openReportModal()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm flex items-center gap-2 transition-colors ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Report/Request
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-grow flex overflow-hidden">
        
        <!-- LEFT: Data Table -->
        <div class="flex-none w-[50%] max-w-[800px] border-r border-slate-200 bg-white flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="flex-grow overflow-auto" id="grid-scroll">
                <table class="w-full border-collapse">
                    <thead class="gantt-header">
                        <tr>
                            <th class="w-10 text-center">ID</th>
                            <th>Task Name</th>
                            <th class="w-16 text-center" title="Dependency">Dep</th>
                            <th class="w-12 text-center" title="Dependency Type">Type</th>
                            <th class="w-12 text-center">Dur</th>
                            <th class="w-20">Start</th>
                            <th class="w-20">Finish</th>
                            <th class="w-12 text-center">%</th>
                            <th class="w-10 text-center"></th>
                        </tr>
                    </thead>
                    <tbody id="grid-body"></tbody>
                </table>
            </div>
        </div>

        <!-- RIGHT: Gantt Chart -->
        <div class="flex-grow flex flex-col bg-white relative min-w-0">
            <div class="flex-grow overflow-auto" id="chart-scroll">
                <div id="chart-container" class="relative w-full">
                    <canvas id="ganttCanvas"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Task Modal -->
    <div id="taskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 m-4 border border-slate-200">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Add New Task</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="p-6 space-y-4 bg-white/95">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Task Name</label>
                    <input type="text" id="m-name" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                        <select id="m-type" onchange="toggleDurationState()" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="Task">Task</option>
                            <option value="Milestone">Milestone</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Duration (Days)</label>
                        <input type="number" id="m-dur" value="1" min="0" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>

                <!-- Dependency Section -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <h4 class="text-xs font-bold text-indigo-800 uppercase mb-2">Dependency Logic</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-1">Predecessor ID</label>
                            <input type="number" id="m-parent" placeholder="e.g. 10" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-1">Dep. Type</label>
                            <select id="m-depType" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                <option value="FS">Finish-to-Start (FS)</option>
                                <option value="SS">Start-to-Start (SS)</option>
                                <option value="FF">Finish-to-Finish (FF)</option>
                                <option value="SF">Start-to-Finish (SF)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                        <input type="date" id="m-start" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">% Complete</label>
                        <input type="number" id="m-pct" value="0" min="0" max="100" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                
                <div id="div-insert" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Insert After</label>
                    <select id="m-insert" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                        <option value="end">-- End of List --</option>
                    </select>
                </div>
                
                <input type="hidden" id="m-finish"> 
            </div>

            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="saveTask()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 m-4 border border-slate-200">
            <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-red-800">Report Issue / Request</h3>
                <button onclick="closeReportModal()" class="text-red-400 hover:text-red-600">&times;</button>
            </div>
            <div class="p-6 space-y-4 bg-white">
                <p class="text-sm text-slate-600 leading-relaxed">
                    Thanks for reporting to <strong>Dorin</strong>. Please describe the issue or suggestion below. 
                    Once saved, a CSV file will downloadâ€”please share it with him to add to the backlog.
                </p>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                    <textarea id="report-text" rows="4" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-500 outline-none" placeholder="Describe the bug or feature request..."></textarea>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeReportModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
                <button onclick="saveReport()" class="px-4 py-2 text-sm font-bold text-white bg-red-600 rounded hover:bg-red-700 shadow-sm">Save & Download</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATASET ---
        let projectData = [
            { id: 1, name: "Project Plan Root", parent: null, depType: "FS", start: "2026-01-08", dur: 0, type: "Milestone", pct: 100 },
            { id: 3, name: "Contract & PO Signed", parent: 1, depType: "FS", start: "2026-01-08", dur: 0, type: "Milestone", pct: 100 },
            { id: 4, name: "Gate 1: Kick Off", parent: 1, depType: "FS", start: "2026-02-04", dur: 0, type: "Milestone", pct: 100 },
            { id: 5, name: "Gate 2: Discovery", parent: 4, depType: "FS", start: "2026-03-10", dur: 0, type: "Milestone", pct: 20 },
            { id: 6, name: "Gate 3: Pilot", parent: 5, depType: "FS", start: "2026-03-20", dur: 0, type: "Milestone", pct: 0 },
            { id: 7, name: "Gate 4: Rollout", parent: 6, depType: "FS", start: "2026-04-27", dur: 0, type: "Milestone", pct: 0 },
            { id: 8, name: "Gate 5: Closure", parent: 7, depType: "FS", start: "2026-05-04", dur: 0, type: "Milestone", pct: 0 },
            { id: 10, name: "Confirm Final Design", parent: 1, depType: "FS", start: "2026-01-09", dur: 3, type: "Task", pct: 100 },
            { id: 11, name: "Prepare SSD & Cabling", parent: 10, depType: "FS", start: "2026-01-14", dur: 2, type: "Task", pct: 100 },
            { id: 12, name: "Enter Orders (GTT)", parent: 10, depType: "FS", start: "2026-01-14", dur: 10, type: "Task", pct: 90 },
            { id: 13, name: "MSA Signature", parent: 10, depType: "FS", start: "2026-01-14", dur: 12, type: "Task", pct: 80 },
            { id: 14, name: "PON Re-signing", parent: 12, depType: "FS", start: "2026-01-28", dur: 5, type: "Task", pct: 50 },
            { id: 15, name: "Orders Validated", parent: 14, depType: "FS", start: "2026-02-04", dur: 2, type: "Task", pct: 0 },
            { id: 16, name: "EnvisionEdge Cert", parent: 1, depType: "FS", start: "2026-01-09", dur: 6, type: "Task", pct: 100 },
            { id: 18, name: "Internal Acceptance", parent: 15, depType: "FS", start: "2026-02-06", dur: 3, type: "Task", pct: 0 },
            { id: 19, name: "PON Validation", parent: 18, depType: "FS", start: "2026-02-11", dur: 1, type: "Task", pct: 0 },
            { id: 20, name: "External Kick Off", parent: 19, depType: "FS", start: "2026-02-12", dur: 2, type: "Task", pct: 0 },
            { id: 21, name: "PID Agreed", parent: 20, depType: "FS", start: "2026-02-16", dur: 2, type: "Task", pct: 0 },
            { id: 22, name: "Plan Created", parent: 16, depType: "FS", start: "2026-01-19", dur: 2, type: "Task", pct: 100 },
            { id: 23, name: "Tracker Created", parent: 16, depType: "FS", start: "2026-01-19", dur: 2, type: "Task", pct: 100 },
            { id: 24, name: "RAID Log Created", parent: 16, depType: "FS", start: "2026-01-19", dur: 2, type: "Task", pct: 100 },
            { id: 26, name: "Share SSD/HLD", parent: 16, depType: "FS", start: "2026-01-19", dur: 8, type: "Task", pct: 60 },
            { id: 27, name: "Share TAD", parent: 15, depType: "FS", start: "2026-02-06", dur: 2, type: "Task", pct: 0 },
            { id: 28, name: "Update IP Addresses", parent: 12, depType: "FS", start: "2026-01-28", dur: 1, type: "Task", pct: 0 },
            { id: 30, name: "TAD Approved", parent: 27, depType: "FS", start: "2026-02-10", dur: 2, type: "Task", pct: 0 },
            { id: 31, name: "Schedule Workshops", parent: 27, depType: "FS", start: "2026-02-10", dur: 2, type: "Task", pct: 0 },
            { id: 32, name: "Config Review (Workshops)", parent: 27, depType: "FS", start: "2026-02-10", dur: 20, type: "Task", pct: 0 },
            { id: 33, name: "Agree Solution", parent: 32, depType: "FS", start: "2026-03-10", dur: 5, type: "Task", pct: 0 },
            { id: 34, name: "Client Tech Info", parent: 28, depType: "FS", start: "2026-01-29", dur: 15, type: "Task", pct: 10 },
            { id: 36, name: "NetProv Confirm", parent: 15, depType: "FS", start: "2026-02-06", dur: 0, type: "Milestone", pct: 0 },
            { id: 37, name: "Pilot Pre-stage", parent: 28, depType: "FS", start: "2026-01-29", dur: 6, type: "Task", pct: 20 },
            { id: 38, name: "Pilot Shipment", parent: 37, depType: "FS", start: "2026-02-06", dur: 15, type: "Task", pct: 0 },
            { id: 39, name: "Rollout Pre-stage", parent: 27, depType: "FS", start: "2026-02-10", dur: 10, type: "Task", pct: 0 },
            { id: 40, name: "Rollout Shipment", parent: 39, depType: "FS", start: "2026-02-24", dur: 15, type: "Task", pct: 0 },
            { id: 42, name: "Identify Pilot Sites", parent: 21, depType: "FS", start: "2026-02-18", dur: 1, type: "Task", pct: 0 },
            { id: 43, name: "Final Workshop", parent: 38, depType: "FS", start: "2026-02-27", dur: 3, type: "Task", pct: 0 },
            { id: 44, name: "Final LLDs", parent: 43, depType: "FS", start: "2026-03-04", dur: 1, type: "Task", pct: 0 },
            { id: 45, name: "Define Success Scope", parent: 33, depType: "FS", start: "2026-03-17", dur: 5, type: "Task", pct: 0 },
            { id: 46, name: "Determine UAT", parent: 33, depType: "FS", start: "2026-03-17", dur: 5, type: "Task", pct: 0 },
            { id: 47, name: "Create Runbook", parent: 43, depType: "FS", start: "2026-03-04", dur: 1, type: "Task", pct: 0 },
            { id: 49, name: "Site 1 Mig", parent: 44, depType: "FS", start: "2026-03-05", dur: 1, type: "Task", pct: 0 },
            { id: 50, name: "Site 2 Mig", parent: 49, depType: "FS", start: "2026-03-06", dur: 2, type: "Task", pct: 0 },
            { id: 51, name: "Site 3 Mig", parent: 50, depType: "FS", start: "2026-03-10", dur: 2, type: "Task", pct: 0 },
            { id: 52, name: "Design Signed", parent: 51, depType: "FS", start: "2026-03-12", dur: 5, type: "Task", pct: 0 },
            { id: 53, name: "Create DDD", parent: 52, depType: "FS", start: "2026-03-19", dur: 1, type: "Task", pct: 0 },
            { id: 54, name: "Handover Net Prov", parent: 53, depType: "FS", start: "2026-03-20", dur: 1, type: "Task", pct: 0 },
            { id: 56, name: "Site 3 Rollout", parent: 54, depType: "FS", start: "2026-03-23", dur: 5, type: "Task", pct: 0 },
            { id: 57, name: "Site 4 Rollout", parent: 56, depType: "FS", start: "2026-03-30", dur: 2, type: "Task", pct: 0 },
            { id: 58, name: "Site 5 Rollout", parent: 57, depType: "FS", start: "2026-04-01", dur: 2, type: "Task", pct: 0 },
            { id: 59, name: "Site 6 Rollout", parent: 58, depType: "FS", start: "2026-04-03", dur: 2, type: "Task", pct: 0 },
            { id: 60, name: "Site 7 Rollout", parent: 59, depType: "FS", start: "2026-04-07", dur: 2, type: "Task", pct: 0 },
            { id: 61, name: "Site 8 Rollout", parent: 60, depType: "FS", start: "2026-04-09", dur: 2, type: "Task", pct: 0 },
            { id: 62, name: "Site 9 Rollout", parent: 61, depType: "FS", start: "2026-04-13", dur: 2, type: "Task", pct: 0 },
            { id: 63, name: "Site 10 Rollout", parent: 62, depType: "FS", start: "2026-04-15", dur: 2, type: "Task", pct: 0 },
            { id: 64, name: "Site 11 Rollout", parent: 63, depType: "FS", start: "2026-04-17", dur: 2, type: "Task", pct: 0 },
            { id: 65, name: "Site 12 Rollout", parent: 64, depType: "FS", start: "2026-04-21", dur: 2, type: "Task", pct: 0 },
            { id: 66, name: "Site 13 Rollout", parent: 65, depType: "FS", start: "2026-04-23", dur: 2, type: "Task", pct: 0 },
            { id: 67, name: "Site 14 Rollout", parent: 66, depType: "FS", start: "2026-04-27", dur: 2, type: "Task", pct: 0 },
            { id: 68, name: "EnvisionDX Access", parent: 49, depType: "FS", start: "2026-03-06", dur: 1, type: "Task", pct: 0 },
            { id: 69, name: "Service Reviews", parent: 49, depType: "FS", start: "2026-03-06", dur: 1, type: "Task", pct: 0 },
            { id: 71, name: "Lessons Learned", parent: 67, depType: "FS", start: "2026-04-29", dur: 3, type: "Task", pct: 0 },
            { id: 72, name: "Project Closed", parent: 71, depType: "FS", start: "2026-05-04", dur: 0, type: "Milestone", pct: 0 }
        ];

        // --- 2. LOGIC ---
        const criticalPathSet = new Set();
        let showBaseline = true;

        function initData() {
            projectData.forEach(t => {
                if (!t.baseStart) t.baseStart = t.start;
                if (!t.baseDur) t.baseDur = t.dur;
                if (!t.depType) t.depType = "FS"; 
            });
        }

        function calculateCriticalPath() {
            criticalPathSet.clear();
            if (projectData.length === 0) return;
            const maxId = Math.max(...projectData.map(t => t.id));
            let currentId = maxId;
            while (currentId) {
                criticalPathSet.add(currentId);
                const task = projectData.find(t => t.id === currentId);
                currentId = task ? task.parent : null;
            }
        }

        function calculateSchedule() {
            const sortedTasks = [...projectData].sort((a, b) => a.id - b.id);
            sortedTasks.forEach(task => {
                if (task.parent) {
                    const parent = projectData.find(p => p.id === task.parent);
                    if (parent) {
                        const pStart = new Date(parent.start);
                        const pEnd = new Date(pStart.getTime() + (parent.dur * 86400000));
                        let newStart;
                        switch(task.depType) {
                            case 'SS': newStart = pStart; break;
                            case 'FF': newStart = new Date(pEnd.getTime() - (task.dur * 86400000)); break;
                            case 'SF': newStart = new Date(pStart.getTime() - (task.dur * 86400000)); break;
                            case 'FS': default: newStart = pEnd; break;
                        }
                        if (isNaN(newStart.getTime())) newStart = new Date(parent.start);
                        task.start = newStart.toISOString().split('T')[0];
                    }
                }
            });
        }

        function setBaseline() {
            if(confirm("Overwrite Baseline?")) {
                projectData.forEach(t => { t.baseStart = t.start; t.baseDur = t.dur; });
                renderChart();
            }
        }

        function toggleBaseline() {
            showBaseline = document.getElementById('showBaselineToggle').checked;
            renderChart();
        }

        function toggleDurationState() {
            const type = document.getElementById('m-type').value;
            const durInput = document.getElementById('m-dur');
            if (type === 'Milestone') {
                durInput.value = 0;
                durInput.disabled = true;
                durInput.classList.add('bg-slate-100', 'text-slate-400');
            } else {
                durInput.disabled = false;
                durInput.classList.remove('bg-slate-100', 'text-slate-400');
            }
        }

        // --- IMPORT/EXPORT ---
        function downloadCSV() {
            const headers = ["ID", "Name", "Type", "Parent", "DepType", "Duration", "Start", "Finish", "Percent", "BaseStart", "BaseDur"];
            const rows = projectData.map(t => {
                const startDate = new Date(t.start);
                const endDate = new Date(startDate.getTime() + (t.dur * 86400000));
                return [
                    t.id, `"${t.name.replace(/"/g, '""')}"`, t.type, t.parent || '', t.depType || 'FS',
                    t.dur, t.start, endDate.toISOString().split('T')[0], t.pct, t.baseStart || t.start, t.baseDur || t.dur
                ];
            });
            const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "sdwan_project.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                const newProjectData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || lines[i].split(',');
                    const clean = cols.map(c => c.replace(/^"|"$/g, '').replace(/""/g, '"'));
                    if (clean.length >= 9) {
                        newProjectData.push({
                            id: parseInt(clean[0]), name: clean[1], type: clean[2], parent: clean[3] ? parseInt(clean[3]) : null,
                            depType: clean[4] || 'FS', dur: parseInt(clean[5]), start: clean[6], pct: parseInt(clean[8]),
                            baseStart: clean[9] || clean[6], baseDur: parseInt(clean[10]) || parseInt(clean[5])
                        });
                    }
                }
                if (newProjectData.length > 0) {
                    projectData = newProjectData;
                    refreshView();
                    alert("Project loaded!");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- REPORTING ---
        function openReportModal() {
            document.getElementById('report-text').value = "";
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        function saveReport() {
            const text = document.getElementById('report-text').value;
            if(!text.trim()) { alert("Please enter a description."); return; }
            
            const timestamp = new Date().toISOString();
            const headers = ["Timestamp", "Type", "Description"];
            const row = [timestamp, "User Report/Request", `"${text.replace(/"/g, '""')}"`];
            const csvContent = [headers.join(","), row.join(",")].join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const filename = `report_dorin_${new Date().toISOString().slice(0,10)}.csv`;
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            closeReportModal();
            alert("Report downloaded! Please send to Dorin.");
        }

        // --- MODAL ---
        let editingId = null;

        function openTaskModal(id = null) {
            try {
                const modal = document.getElementById('taskModal');
                const insertSelect = document.getElementById('m-insert');
                insertSelect.innerHTML = '<option value="end">-- End of List --</option>';
                projectData.forEach((t, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.text = `After: [${t.id}] ${t.name.substring(0,30)}...`;
                    insertSelect.appendChild(opt);
                });

                editingId = id;
                if (id) {
                    document.getElementById('modalTitle').innerText = "Edit Task";
                    document.getElementById('div-insert').classList.add('hidden');
                    const task = projectData.find(t => t.id === id);
                    document.getElementById('m-name').value = task.name;
                    document.getElementById('m-type').value = task.type;
                    document.getElementById('m-parent').value = task.parent || '';
                    document.getElementById('m-depType').value = task.depType || 'FS';
                    document.getElementById('m-start').value = task.start;
                    document.getElementById('m-dur').value = task.dur;
                    document.getElementById('m-pct').value = task.pct;
                } else {
                    document.getElementById('modalTitle').innerText = "Add New Task";
                    document.getElementById('div-insert').classList.remove('hidden');
                    document.getElementById('m-name').value = "";
                    document.getElementById('m-type').value = "Task";
                    document.getElementById('m-parent').value = "";
                    document.getElementById('m-depType').value = "FS"; 
                    document.getElementById('m-start').value = new Date().toISOString().split('T')[0];
                    document.getElementById('m-dur').value = "1";
                    document.getElementById('m-pct').value = "0";
                }
                toggleDurationState();
                modal.classList.remove('hidden');
            } catch (err) { console.error(err); alert("Error opening modal"); }
        }

        function closeModal() { document.getElementById('taskModal').classList.add('hidden'); }

        function saveTask() {
            try {
                const name = document.getElementById('m-name').value || "New Task";
                const type = document.getElementById('m-type').value;
                let dur = parseInt(document.getElementById('m-dur').value) || 0;
                if (type === 'Milestone') dur = 0; // Enforce
                
                const start = document.getElementById('m-start').value || new Date().toISOString().split('T')[0];
                const pct = parseInt(document.getElementById('m-pct').value) || 0;
                const parent = parseInt(document.getElementById('m-parent').value) || null;
                const depType = document.getElementById('m-depType').value;

                if (editingId) {
                    const task = projectData.find(t => t.id === editingId);
                    if (task) Object.assign(task, { name, type, dur, start, pct, parent, depType });
                } else {
                    const maxId = projectData.length > 0 ? Math.max(...projectData.map(t => t.id)) : 0;
                    const newId = maxId + 1;
                    const insertVal = document.getElementById('m-insert').value;
                    const newTask = { id: newId, name, type, dur, start, pct, parent, depType, baseStart: start, baseDur: dur };
                    if (insertVal === "end") projectData.push(newTask);
                    else projectData.splice(parseInt(insertVal) + 1, 0, newTask);
                }
                refreshView();
                closeModal();
            } catch(err) { console.error(err); alert("Error saving task"); }
        }

        function deleteTask(id) {
            if(confirm("Delete Task?")) {
                const idx = projectData.findIndex(t => t.id === id);
                if (idx > -1) { projectData.splice(idx, 1); refreshView(); }
            }
        }

        // --- INIT & RENDER ---
        window.addEventListener('load', () => {
            initData();
            refreshView();
            
            // Sync Scroll
            const grid = document.getElementById('grid-scroll');
            const chart = document.getElementById('chart-scroll');
            let isSyncingLeft = false; 
            let isSyncingRight = false;
            grid.onscroll = function() { if (!isSyncingLeft) { isSyncingRight = true; chart.scrollTop = this.scrollTop; } isSyncingLeft = false; };
            chart.onscroll = function() { if (!isSyncingRight) { isSyncingLeft = true; grid.scrollTop = this.scrollTop; } isSyncingRight = false; };
        });

        function refreshView() {
            calculateSchedule();
            calculateCriticalPath();
            renderTable();
            renderChart();
            document.getElementById('task-count').innerText = projectData.length;
        }

        function renderTable() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            projectData.forEach(task => {
                const endStr = new Date(new Date(task.start).getTime() + (task.dur * 86400000)).toISOString().split('T')[0];
                const row = document.createElement('tr');
                row.className = 'gantt-row hover:bg-slate-50 transition-colors group';
                
                const typeBadge = task.type === 'Milestone' 
                    ? `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase border border-purple-200 text-purple-600 bg-purple-50">Milestone</span>`
                    : `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase border border-slate-200 text-slate-500">Task</span>`;

                row.innerHTML = `
                    <td class="font-mono text-xs text-slate-400 font-bold text-center border-r border-slate-100">${task.id}</td>
                    <td class="border-r border-slate-100 relative editable" onclick="openTaskModal(${task.id})">
                        <div class="truncate-text font-medium text-slate-700 text-xs">${task.name}</div>
                    </td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100">${task.parent || '-'}</td>
                    <td class="text-center border-r border-slate-100">${typeBadge}</td>
                    <td class="text-center font-mono text-xs text-slate-500 border-r border-slate-100">${task.dur}d</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100">${task.start}</td>
                    <td class="font-mono text-[10px] text-slate-500 border-r border-slate-100">${endStr}</td>
                    <td class="text-center border-r border-slate-100">
                        <div class="flex items-center justify-center gap-1">
                            <span class="text-[9px] font-bold text-slate-400">${task.pct}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <button onclick="openTaskModal(${task.id})" class="btn-icon inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                        <button onclick="deleteTask(${task.id})" class="btn-icon-danger inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        let chartInstance = null;
        function renderChart() {
            const ROW_HEIGHT = 40; const HEADER_HEIGHT = 48;
            document.getElementById('chart-container').style.height = `${(projectData.length * ROW_HEIGHT) + HEADER_HEIGHT}px`;
            const ctx = document.getElementById('ganttCanvas').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const baselineData = projectData.map(t => {
                if(!showBaseline) return { x: null, y: `Row ${t.id}` };
                const s = new Date(t.baseStart);
                const e = new Date(s.getTime() + ((t.baseDur || 0.5) * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}` };
            });

            const actualData = projectData.map(t => {
                const s = new Date(t.start);
                // Give milestones a minimal "data" width for coordinates, but they will be transparent
                const displayDur = t.type === 'Milestone' ? 0.5 : t.dur;
                const e = new Date(s.getTime() + (displayDur * 86400000));
                return { x: [s.getTime(), e.getTime()], y: `Row ${t.id}`, status: t.pct };
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: projectData.map((_, i) => `Row ${projectData[i].id}`),
                    datasets: [
                        { label: 'Baseline', data: baselineData, backgroundColor: '#94A3B8', barThickness: 4, grouped: false, order: 1 },
                        { label: 'Actual', data: actualData, backgroundColor: (ctx) => {
                            const dataIndex = ctx.dataIndex;
                            if (dataIndex === undefined || dataIndex < 0) return '#CBD5E1';
                            const task = projectData[dataIndex];
                            if (task.type === 'Milestone') return 'rgba(0,0,0,0)'; // Transparent bar for milestones
                            
                            const pct = ctx.raw?.status;
                            if(pct === 100) return '#10B981'; if(pct > 0) return '#F59E0B'; return '#CBD5E1';
                        }, borderRadius: 3, barPercentage: 0.6, grouped: false, order: 0 }
                    ]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 0, bottom: 0, left: 0, right: 20 } },
                    plugins: { legend: { display: false }, tooltip: { enabled: true } },
                    scales: {
                        x: { type: 'time', time: { unit: 'week' }, position: 'top', min: '2026-01-08', grid: { color: '#F1F5F9' }, ticks: { font: { size: 10 }, color: '#94A3B8' } },
                        y: { display: false, grid: { display: false } }
                    }
                },
                plugins: [{
                    id: 'customRender',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        const meta = chart.getDatasetMeta(1); // Actual dataset
                        
                        // 1. Draw Dependencies
                        const idToIndex = {}; projectData.forEach((t, i) => idToIndex[t.id] = i);
                        ctx.save(); ctx.lineJoin = 'round'; ctx.lineCap = 'round';
                        projectData.forEach((task, index) => {
                            if (task.parent && idToIndex[task.parent] !== undefined) {
                                const pIdx = idToIndex[task.parent];
                                const pBar = meta.data[pIdx];
                                const cBar = meta.data[index];
                                if (!pBar || !cBar) return;

                                const isCrit = criticalPathSet.has(task.id) && criticalPathSet.has(task.parent);
                                ctx.strokeStyle = isCrit ? '#9333EA' : '#CBD5E1';
                                ctx.lineWidth = isCrit ? 2.5 : 1.5;
                                if (!isCrit) ctx.setLineDash([]);

                                // Calc positions
                                const getCoord = (bar, side, type) => {
                                    if (type === 'Milestone') return bar.base; // Milestone connect point is start
                                    return side === 'left' ? bar.base : bar.x;
                                };

                                const pType = projectData[pIdx].type;
                                const cType = task.type;

                                let startX, endX;
                                const startY = pBar.y;
                                const endY = cBar.y;

                                // Dep Logic
                                if (task.depType === 'SS' || task.depType === 'SF') startX = getCoord(pBar, 'left', pType);
                                else startX = getCoord(pBar, 'right', pType);

                                if (task.depType === 'FF' || task.depType === 'SF') endX = getCoord(cBar, 'right', cType);
                                else endX = getCoord(cBar, 'left', cType);

                                // Offsets
                                if (startX === (pType==='Milestone'?pBar.base:pBar.x)) startX += 0; else startX -= 0;
                                if (endX === (cType==='Milestone'?cBar.base:cBar.x)) endX += 4; else endX -= 4;

                                ctx.beginPath();
                                ctx.moveTo(startX, startY);
                                const cp1x = startX + 15; const cp2x = endX - 15;
                                ctx.bezierCurveTo(cp1x, startY, cp2x, endY, endX, endY);
                                ctx.stroke();

                                ctx.beginPath();
                                ctx.fillStyle = ctx.strokeStyle;
                                ctx.moveTo(endX, endY);
                                ctx.lineTo(endX - 4, endY - 3);
                                ctx.lineTo(endX - 4, endY + 3);
                                ctx.fill();
                            }
                        });

                        // 2. Draw Diamonds for Milestones
                        projectData.forEach((task, index) => {
                            if (task.type === 'Milestone') {
                                const bar = meta.data[index];
                                if (!bar) return;
                                const x = bar.base; // Draw at Start
                                const y = bar.y;
                                const size = 6;
                                
                                ctx.beginPath();
                                ctx.fillStyle = getStatusColor(task.pct);
                                ctx.moveTo(x, y - size);
                                ctx.lineTo(x + size, y);
                                ctx.lineTo(x, y + size);
                                ctx.lineTo(x - size, y);
                                ctx.fill();
                                
                                // Outline for visibility
                                ctx.strokeStyle = '#1E293B';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                            }
                        });
                        ctx.restore();
                    }
                }]
            });
        }
        
        function getStatusColor(pct) { if (pct === 100) return '#10B981'; if (pct > 0) return '#F59E0B'; return '#94A3B8'; }
    </script>
</body>
</html>
